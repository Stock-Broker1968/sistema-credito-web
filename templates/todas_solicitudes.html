{% extends "base.html" %}

{% block title %}Todas las Solicitudes - Sistema de Análisis Crediticio{% endblock %}

{% block extra_css %}
<style>
    .filter-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .stats-overview {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .status-badge {
        font-size: 0.8em;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: bold;
    }
    
    .status-aprobado { background: #d4edda; color: #155724; }
    .status-rechazado { background: #f8d7da; color: #721c24; }
    .status-zona_gris { background: #fff3cd; color: #856404; }
    .status-en_proceso { background: #d1ecf1; color: #0c5460; }
    
    .table-actions .btn {
        margin: 1px;
        padding: 4px 8px;
        font-size: 0.8em;
    }
    
    .analista-badge {
        background: #e9ecef;
        color: #495057;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
    }

    .busqueda-resaltado {
        background-color: #fff3cd !important;
        animation: destacar 2s ease-in-out;
    }

    @keyframes destacar {
        0% { background-color: #fff3cd; }
        50% { background-color: #ffeaa7; }
        100% { background-color: #fff3cd; }
    }
    
    @media (max-width: 768px) {
        .table-responsive {
            font-size: 0.85em;
        }
        
        .filter-card .row {
            gap: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-custom">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="mb-1">
                                <i class="fas fa-folder-open text-primary me-3"></i>
                                Todas las Solicitudes del Sistema
                            </h1>
                            <p class="text-muted mb-0">
                                Vista administrativa completa de solicitudes crediticias
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button onclick="exportarDatos()" class="btn btn-success me-2">
                                <i class="fas fa-download me-2"></i>Exportar
                            </button>
                            <a href="{{ url_for('panel_admin') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Panel Admin
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Generales -->
    <div class="stats-overview">
        <div class="row text-center">
            <div class="col-md-2 col-6 mb-3 mb-md-0">
                <h3 class="text-primary">{{ solicitudes.total }}</h3>
                <p class="mb-0 fw-bold">Total</p>
            </div>
            <div class="col-md-2 col-6 mb-3 mb-md-0">
                <h3 class="text-success">{{ solicitudes.items | selectattr('decision', 'equalto', 'aprobado') | list | length }}</h3>
                <p class="mb-0 fw-bold">Aprobadas</p>
            </div>
            <div class="col-md-2 col-6 mb-3 mb-md-0">
                <h3 class="text-danger">{{ solicitudes.items | selectattr('decision', 'equalto', 'rechazado') | list | length }}</h3>
                <p class="mb-0 fw-bold">Rechazadas</p>
            </div>
            <div class="col-md-2 col-6 mb-3 mb-md-0">
                <h3 class="text-warning">{{ solicitudes.items | selectattr('decision', 'equalto', 'zona_gris') | list | length }}</h3>
                <p class="mb-0 fw-bold">Zona Gris</p>
            </div>
            <div class="col-md-2 col-6 mb-3 mb-md-0">
                <h3 class="text-info">{{ solicitudes.items | selectattr('decision', 'equalto', None) | list | length }}</h3>
                <p class="mb-0 fw-bold">Pendientes</p>
            </div>
            <div class="col-md-2 col-6">
                <h3 class="text-secondary">
                    {% if solicitudes.total > 0 %}
                        {{ "%.1f"|format((solicitudes.items | selectattr('decision', 'equalto', 'aprobado') | list | length / solicitudes.total) * 100) }}%
                    {% else %}
                        0%
                    {% endif %}
                </h3>
                <p class="mb-0 fw-bold">Tasa Aprobación</p>
            </div>
        </div>
    </div>

    <!-- Filtros Avanzados -->
    <div class="filter-card">
        <form method="GET" class="row align-items-end">
            <div class="col-md-2 mb-2">
                <label class="form-label fw-bold text-white">Estado:</label>
                <select name="decision" class="form-control form-control-custom">
                    <option value="">Todos</option>
                    <option value="aprobado" {{ 'selected' if filtro_decision == 'aprobado' }}>Aprobados</option>
                    <option value="rechazado" {{ 'selected' if filtro_decision == 'rechazado' }}>Rechazados</option>
                    <option value="zona_gris" {{ 'selected' if filtro_decision == 'zona_gris' }}>Zona Gris</option>
                    <option value="en_proceso" {{ 'selected' if filtro_decision == 'en_proceso' }}>En Proceso</option>
                </select>
            </div>
            <div class="col-md-2 mb-2">
                <label class="form-label fw-bold text-white">Analista:</label>
                <select name="analista" class="form-control form-control-custom">
                    <option value="">Todos</option>
                    {% for analista in analistas %}
                    <option value="{{ analista.id }}" {{ 'selected' if filtro_analista|string == analista.id|string }}>
                        {{ analista.codigo }} - {{ analista.nombre[:20] }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 mb-2">
                <label class="form-label fw-bold text-white">Desde:</label>
                <input type="date" name="fecha_desde" class="form-control form-control-custom" 
                       value="{{ request.args.get('fecha_desde', '') }}">
            </div>
            <div class="col-md-2 mb-2">
                <label class="form-label fw-bold text-white">Hasta:</label>
                <input type="date" name="fecha_hasta" class="form-control form-control-custom" 
                       value="{{ request.args.get('fecha_hasta', '') }}">
            </div>
            <div class="col-md-2 mb-2">
                <label class="form-label fw-bold text-white">Monto Min:</label>
                <input type="number" name="monto_min" class="form-control form-control-custom" 
                       placeholder="$0" value="{{ request.args.get('monto_min', '') }}">
            </div>
            <div class="col-md-2 mb-2">
                <button type="submit" class="btn btn-light w-100">
                    <i class="fas fa-filter me-2"></i>Filtrar
                </button>
            </div>
        </form>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <button class="btn btn-outline-light btn-sm me-2" onclick="limpiarFiltros()">
                    <i class="fas fa-times me-1"></i>Limpiar Filtros
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="filtrosRapidos()">
                    <i class="fas fa-bolt me-1"></i>Filtros Rápidos
                </button>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-white-50">
                    Mostrando {{ solicitudes.items|length }} de {{ solicitudes.total }} solicitudes
                </small>
            </div>
        </div>
    </div>

    <!-- Tabla de Solicitudes -->
    <div class="card card-custom">
        <div class="card-header bg-transparent">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Lista Completa de Solicitudes
                    </h5>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="busquedaRapida()">
                        <i class="fas fa-search me-1"></i>Buscar
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="estadisticasRapidas()">
                        <i class="fas fa-chart-pie me-1"></i>Stats
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="limpiarBusqueda()">
                        <i class="fas fa-eraser me-1"></i>Limpiar
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if solicitudes.items %}
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tablaSolicitudes">
                    <thead class="table-light">
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th onclick="ordenarPor('numero')">
                                Número <i class="fas fa-sort"></i>
                            </th>
                            <th>Cliente</th>
                            <th>Analista</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>FICO</th>
                            <th>TDSR</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for solicitud in solicitudes.items %}
                        <tr data-solicitud-id="{{ solicitud.id }}">
                            <td>
                                <input type="checkbox" class="solicitud-checkbox" value="{{ solicitud.id }}" onchange="actualizarSeleccion()">
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ solicitud.numero }}</span>
                            </td>
                            <td>
                                {% if solicitud.cliente %}
                                    <strong>{{ solicitud.cliente.nombre }} {{ solicitud.cliente.apellido_paterno }}</strong><br>
                                    <small class="text-muted">{{ solicitud.cliente.rfc }}</small>
                                {% else %}
                                    <em class="text-muted">Sin cliente</em>
                                {% endif %}
                            </td>
                            <td>
                                <span class="analista-badge">{{ solicitud.analista.codigo }}</span><br>
                                <small class="text-muted">{{ solicitud.analista.nombre[:20] }}...</small>
                            </td>
                            <td>
                                {% if solicitud.monto_solicitado %}
                                    <strong>${{ "{:,.0f}".format(solicitud.monto_solicitado) }}</strong>
                                    {% if solicitud.monto_aprobado %}
                                        <br><small class="text-success">Aprob: ${{ "{:,.0f}".format(solicitud.monto_aprobado) }}</small>
                                    {% endif %}
                                {% else %}
                                    <em class="text-muted">No definido</em>
                                {% endif %}
                            </td>
                            <td>
                                {% if solicitud.decision == 'aprobado' %}
                                    <span class="status-badge status-aprobado">
                                        <i class="fas fa-check me-1"></i>Aprobado
                                    </span>
                                {% elif solicitud.decision == 'rechazado' %}
                                    <span class="status-badge status-rechazado">
                                        <i class="fas fa-times me-1"></i>Rechazado
                                    </span>
                                {% elif solicitud.decision == 'zona_gris' %}
                                    <span class="status-badge status-zona_gris">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Zona Gris
                                    </span>
                                {% else %}
                                    <span class="status-badge status-en_proceso">
                                        <i class="fas fa-clock me-1"></i>En Proceso
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if solicitud.cliente %}
                                    {% if solicitud.cliente.fico_score >= 700 %}
                                        <span class="badge bg-success">{{ solicitud.cliente.fico_score }}</span>
                                    {% elif solicitud.cliente.fico_score >= 650 %}
                                        <span class="badge bg-warning">{{ solicitud.cliente.fico_score }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ solicitud.cliente.fico_score }}</span>
                                    {% endif %}
                                {% else %}
                                    <em class="text-muted">N/A</em>
                                {% endif %}
                            </td>
                            <td>
                                {% if solicitud.cliente %}
                                    {% if solicitud.cliente.tdsr <= 30 %}
                                        <span class="badge bg-success">{{ solicitud.cliente.tdsr }}%</span>
                                    {% elif solicitud.cliente.tdsr <= 35 %}
                                        <span class="badge bg-warning">{{ solicitud.cliente.tdsr }}%</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ solicitud.cliente.tdsr }}%</span>
                                    {% endif %}
                                {% else %}
                                    <em class="text-muted">N/A</em>
                                {% endif %}
                            </td>
                            <td>
                                <small>
                                    {{ solicitud.fecha_solicitud.strftime('%d/%m/%Y') }}<br>
                                    <span class="text-muted">{{ solicitud.fecha_solicitud.strftime('%H:%M') }}</span>
                                </small>
                            </td>
                            <td>
                                <div class="table-actions">
                                    <a href="{{ url_for('ver_solicitud', id=solicitud.id) }}" 
                                       class="btn btn-outline-info btn-sm" 
                                       title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    {% if solicitud.decision %}
                                        <a href="{{ url_for('resultado_solicitud', id=solicitud.id) }}" 
                                           class="btn btn-outline-success btn-sm" 
                                           title="Ver resultado">
                                            <i class="fas fa-file-alt"></i>
                                        </a>
                                    {% endif %}
                                    
                                    <button class="btn btn-outline-secondary btn-sm" 
                                            onclick="verHistorial({{ solicitud.id }})" 
                                            title="Ver historial">
                                        <i class="fas fa-history"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación -->
            {% if solicitudes.pages > 1 %}
            <div class="card-footer bg-transparent">
                <nav aria-label="Paginación de solicitudes">
                    <ul class="pagination justify-content-center mb-0">
                        {% if solicitudes.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('todas_solicitudes', page=solicitudes.prev_num, **request.args) }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for page_num in solicitudes.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != solicitudes.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('todas_solicitudes', page=page_num, **request.args) }}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">…</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if solicitudes.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('todas_solicitudes', page=solicitudes.next_num, **request.args) }}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            
            {% else %}
            <!-- Estado vacío -->
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-4"></i>
                <h4 class="text-muted">No hay solicitudes</h4>
                <p class="text-muted mb-4">
                    {% if request.args %}
                        No se encontraron solicitudes con los filtros aplicados.
                    {% else %}
                        No hay solicitudes registradas en el sistema.
                    {% endif %}
                </p>
                <button onclick="limpiarFiltros()" class="btn btn-primary">
                    <i class="fas fa-filter me-2"></i>Limpiar Filtros
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Acciones Masivas -->
    {% if solicitudes.items %}
    <div class="card card-custom mt-3" id="accionesMasivas" style="display: none;">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        Acciones Masivas (<span id="selectedCount">0</span> seleccionadas)
                    </h6>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="exportarSeleccionadas()">
                        <i class="fas fa-download me-1"></i>Exportar
                    </button>
                    <button class="btn btn-outline-info btn-sm me-2" onclick="generarReporteMasivo()">
                        <i class="fas fa-chart-bar me-1"></i>Reporte
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="limpiarSeleccion()">
                        <i class="fas fa-times me-1"></i>Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal para Historial -->
<div class="modal fade" id="historialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history me-2"></i>
                    Historial de Solicitud
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="historialContent">
                <!-- Se llena via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Estadísticas -->
<div class="modal fade" id="estadisticasModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-pie me-2"></i>
                    Estadísticas Detalladas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="estadisticasContent">
                <!-- Se llena via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let solicitudesSeleccionadas = [];
let ultimaBusqueda = '';

// =================== FUNCIONES DE FILTROS ===================
function limpiarBusqueda() {
    const rows = document.querySelectorAll('#tablaSolicitudes tbody tr');
    rows.forEach(row => {
        row.style.display = '';
        row.style.backgroundColor = '';
        row.classList.remove('busqueda-resaltado');
    });
    ultimaBusqueda = '';
}

// =================== FUNCIONES DE HISTORIAL ===================
function verHistorial(solicitudId) {
    // Simulación de datos del historial - en producción vendría del backend
    const historial = `
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-marker bg-primary"></div>
                <div class="timeline-content">
                    <h6 class="timeline-title">Solicitud Creada</h6>
                    <p class="timeline-time"><i class="fas fa-clock me-1"></i>28/01/2025 09:30 - Analista E001</p>
                    <p class="timeline-description">Solicitud registrada en el sistema con número SOL-${solicitudId.toString().padStart(6, '0')}</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-marker bg-info"></div>
                <div class="timeline-content">
                    <h6 class="timeline-title">Documentos Validados</h6>
                    <p class="timeline-time"><i class="fas fa-clock me-1"></i>28/01/2025 10:15 - Analista E001</p>
                    <p class="timeline-description">Documentos de identidad, comprobantes de ingresos y estados financieros validados correctamente</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-marker bg-warning"></div>
                <div class="timeline-content">
                    <h6 class="timeline-title">Scoring Calculado</h6>
                    <p class="timeline-time"><i class="fas fa-clock me-1"></i>28/01/2025 10:20 - Sistema Automático</p>
                    <p class="timeline-description">Score crediticio calculado: 340/450 puntos<br>
                    <small class="text-muted">FICO: 720, TDSR: 28%, Historial: Excelente</small></p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-marker bg-success"></div>
                <div class="timeline-content">
                    <h6 class="timeline-title">Decisión Tomada</h6>
                    <p class="timeline-time"><i class="fas fa-clock me-1"></i>28/01/2025 10:25 - Analista E001</p>
                    <p class="timeline-description">Solicitud aprobada por $45,000 MXN<br>
                    <small class="text-success">Tasa de interés: 12.5% anual</small></p>
                </div>
            </div>
        </div>
        
        <style>
        .timeline {
            position: relative;
            padding-left: 30px;
            margin-top: 20px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
        }
        .timeline-marker {
            position: absolute;
            left: -22px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #dee2e6;
        }
        .timeline-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }
        .timeline-title {
            margin-bottom: 5px;
            color: #495057;
            font-weight: 600;
        }
        .timeline-time {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 8px;
        }
        .timeline-description {
            margin-bottom: 0;
            color: #495057;
        }
        </style>
    `;
    
    document.getElementById('historialContent').innerHTML = historial;
    new bootstrap.Modal(document.getElementById('historialModal')).show();
}

// =================== FUNCIONES DE EXPORTACIÓN ===================
function exportarDatos() {
    const formatos = [
        { nombre: 'Excel (.xlsx)', extension: 'xlsx', icono: 'fas fa-file-excel' },
        { nombre: 'CSV (.csv)', extension: 'csv', icono: 'fas fa-file-csv' },
        { nombre: 'PDF (.pdf)', extension: 'pdf', icono: 'fas fa-file-pdf' },
        { nombre: 'JSON (.json)', extension: 'json', icono: 'fas fa-file-code' }
    ];
    
    let mensaje = 'Seleccione el formato de exportación:\n\n';
    formatos.forEach((formato, index) => {
        mensaje += `${index + 1}. ${formato.nombre}\n`;
    });
    
    const seleccion = prompt(mensaje + '\nIngrese el número (1-4):');
    if (seleccion && seleccion >= 1 && seleccion <= 4) {
        const formatoSeleccionado = formatos[seleccion - 1];
        mostrarProgreso('Exportando', `Generando archivo ${formatoSeleccionado.nombre}...`);
        
        // Simular exportación
        setTimeout(() => {
            ocultarProgreso();
            alert(`Archivo exportado exitosamente en formato ${formatoSeleccionado.nombre}`);
            // Aquí iría la lógica real de exportación
        }, 2000);
    }
}

function exportarSeleccionadas() {
    if (solicitudesSeleccionadas.length === 0) {
        alert('Seleccione al menos una solicitud para exportar.');
        return;
    }
    
    const confirmar = confirm(`¿Exportar ${solicitudesSeleccionadas.length} solicitudes seleccionadas?`);
    if (confirmar) {
        mostrarProgreso('Exportando', `Procesando ${solicitudesSeleccionadas.length} solicitudes...`);
        
        setTimeout(() => {
            ocultarProgreso();
            alert(`${solicitudesSeleccionadas.length} solicitudes exportadas exitosamente.`);
        }, 1500);
    }
}

// =================== FUNCIONES DE REPORTES ===================
function generarReporteMasivo() {
    if (solicitudesSeleccionadas.length === 0) {
        alert('Seleccione al menos una solicitud para generar el reporte.');
        return;
    }
    
    if (confirm(`¿Generar reporte consolidado de ${solicitudesSeleccionadas.length} solicitudes?`)) {
        mostrarProgreso('Generando Reporte', 'Analizando datos y generando gráficos...');
        
        setTimeout(() => {
            ocultarProgreso();
            alert('Reporte consolidado generado exitosamente.');
            // Aquí se abriría una nueva ventana/modal con el reporte
        }, 3000);
    }
}

function estadisticasRapidas() {
    const filas = document.querySelectorAll('#tablaSolicitudes tbody tr:not([style*="display: none"])');
    const stats = {
        total: filas.length,
        aprobadas: 0,
        rechazadas: 0,
        zonaGris: 0,
        pendientes: 0,
        montoTotal: 0,
        montoPromedio: 0,
        ficoPromedio: 0,
        tdsrPromedio: 0
    };
    
    let sumaFico = 0, sumaTdsr = 0, contadorFico = 0, contadorTdsr = 0;
    
    filas.forEach(fila => {
        const estado = fila.querySelector('.status-badge').textContent.trim();
        
        if (estado.includes('Aprobado')) stats.aprobadas++;
        else if (estado.includes('Rechazado')) stats.rechazadas++;
        else if (estado.includes('Zona Gris')) stats.zonaGris++;
        else stats.pendientes++;
        
        // Calcular montos
        const montoCell = fila.cells[4].textContent;
        const montoMatch = montoCell.match(/\$[\d,]+/);
        if (montoMatch) {
            const monto = parseFloat(montoMatch[0].replace(/[$,]/g, ''));
            if (!isNaN(monto)) stats.montoTotal += monto;
        }
        
        // Calcular FICO promedio
        const ficoCell = fila.cells[6];
        const ficoBadge = ficoCell.querySelector('.badge');
        if (ficoBadge) {
            const fico = parseInt(ficoBadge.textContent);
            if (!isNaN(fico)) {
                sumaFico += fico;
                contadorFico++;
            }
        }
        
        // Calcular TDSR promedio
        const tdsrCell = fila.cells[7];
        const tdsrBadge = tdsrCell.querySelector('.badge');
        if (tdsrBadge) {
            const tdsr = parseFloat(tdsrBadge.textContent.replace('%', ''));
            if (!isNaN(tdsr)) {
                sumaTdsr += tdsr;
                contadorTdsr++;
            }
        }
    });
    
    stats.montoPromedio = stats.total > 0 ? stats.montoTotal / stats.total : 0;
    stats.ficoPromedio = contadorFico > 0 ? sumaFico / contadorFico : 0;
    stats.tdsrPromedio = contadorTdsr > 0 ? sumaTdsr / contadorTdsr : 0;
    
    const tasaAprobacion = stats.total > 0 ? ((stats.aprobadas / stats.total) * 100).toFixed(1) : 0;
    const tasaRechazo = stats.total > 0 ? ((stats.rechazadas / stats.total) * 100).toFixed(1) : 0;
    
    const estadisticasHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Resumen General</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-primary">${stats.total}</h4>
                                <small>Total Solicitudes</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success">${tasaAprobacion}%</h4>
                                <small>Tasa Aprobación</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6"><strong>Aprobadas:</strong></div>
                            <div class="col-6 text-success">${stats.aprobadas} (${tasaAprobacion}%)</div>
                        </div>
                        <div class="row">
                            <div class="col-6"><strong>Rechazadas:</strong></div>
                            <div class="col-6 text-danger">${stats.rechazadas} (${tasaRechazo}%)</div>
                        </div>
                        <div class="row">
                            <div class="col-6"><strong>Zona Gris:</strong></div>
                            <div class="col-6 text-warning">${stats.zonaGris}</div>
                        </div>
                        <div class="row">
                            <div class="col-6"><strong>Pendientes:</strong></div>
                            <div class="col-6 text-info">${stats.pendientes}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Análisis Financiero</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <strong>Monto Total:</strong>
                                <h5 class="text-success">${stats.montoTotal.toLocaleString('es-MX')}</h5>
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Monto Promedio:</strong>
                                <h6 class="text-primary">${stats.montoPromedio.toLocaleString('es-MX', {maximumFractionDigits: 0})}</h6>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6"><strong>FICO Promedio:</strong></div>
                            <div class="col-6">
                                <span class="badge ${stats.ficoPromedio >= 700 ? 'bg-success' : stats.ficoPromedio >= 650 ? 'bg-warning' : 'bg-danger'}">
                                    ${stats.ficoPromedio.toFixed(0)}
                                </span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6"><strong>TDSR Promedio:</strong></div>
                            <div class="col-6">
                                <span class="badge ${stats.tdsrPromedio <= 30 ? 'bg-success' : stats.tdsrPromedio <= 35 ? 'bg-warning' : 'bg-danger'}">
                                    ${stats.tdsrPromedio.toFixed(1)}%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Insights y Recomendaciones</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            ${tasaAprobacion > 70 ? '<li class="text-success"><i class="fas fa-check-circle me-2"></i>Excelente tasa de aprobación, indicando buen perfil de solicitantes.</li>' : ''}
                            ${stats.zonaGris > stats.total * 0.2 ? '<li class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Alto porcentaje en zona gris, revisar criterios de evaluación.</li>' : ''}
                            ${stats.ficoPromedio < 650 ? '<li class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>FICO promedio bajo, considerar estrategias de mitigación de riesgo.</li>' : ''}
                            ${stats.tdsrPromedio > 35 ? '<li class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>TDSR promedio alto, revisar capacidad de pago.</li>' : ''}
                            <li class="text-info"><i class="fas fa-info-circle me-2"></i>Análisis basado en ${stats.total} solicitudes ${ultimaBusqueda ? 'filtradas' : 'totales'}.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('estadisticasContent').innerHTML = estadisticasHTML;
    new bootstrap.Modal(document.getElementById('estadisticasModal')).show();
}

// =================== FUNCIONES DE UTILIDAD ===================
function mostrarProgreso(titulo, mensaje) {
    // Crear modal de progreso si no existe
    let modalProgreso = document.getElementById('progresoModal');
    if (!modalProgreso) {
        const modalHTML = `
            <div class="modal fade" id="progresoModal" tabindex="-1" data-bs-backdrop="static">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                        <div class="modal-body text-center p-4">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <h6 id="progresoTitulo">${titulo}</h6>
                            <p id="progresoMensaje" class="text-muted mb-0">${mensaje}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modalProgreso = document.getElementById('progresoModal');
    } else {
        document.getElementById('progresoTitulo').textContent = titulo;
        document.getElementById('progresoMensaje').textContent = mensaje;
    }
    
    new bootstrap.Modal(modalProgreso).show();
}

function ocultarProgreso() {
    const modalProgreso = document.getElementById('progresoModal');
    if (modalProgreso) {
        bootstrap.Modal.getInstance(modalProgreso).hide();
    }
}

function formatearNumero(numero) {
    return new Intl.NumberFormat('es-MX').format(numero);
}

function formatearMoneda(monto) {
    return new Intl.NumberFormat('es-MX', {
        style: 'currency',
        currency: 'MXN'
    }).format(monto);
}

// =================== EVENTOS Y INICIALIZACIÓN ===================
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Agregar eventos a los checkboxes
    document.querySelectorAll('.solicitud-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', actualizarSeleccion);
    });
    
    // Auto-actualizar cada 30 segundos (opcional)
    // setInterval(function() {
    //     if (confirm('¿Actualizar datos?')) {
    //         location.reload();
    //     }
    // }, 30000);
    
    console.log('Sistema de Análisis Crediticio - Vista de Todas las Solicitudes cargada correctamente');
});

// =================== FUNCIONES ADICIONALES ===================
function verDetalleRapido(solicitudId) {
    // Función para mostrar detalles rápidos en un popover o modal pequeño
    const detalleHTML = `
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Solicitud #${solicitudId.toString().padStart(6, '0')}</h6>
            </div>
            <div class="card-body">
                <p><strong>Estado:</strong> <span class="badge bg-success">Aprobado</span></p>
                <p><strong>Monto:</strong> $45,000</p>
                <p><strong>Score:</strong> 340/450</p>
                <p><strong>Analista:</strong> E001</p>
            </div>
        </div>
    `;
    
    // Mostrar en un modal pequeño o tooltip
    alert('Detalle rápido - Funcionalidad en desarrollo');
}

function imprimirVista() {
    window.print();
}

function compartirVista() {
    if (navigator.share) {
        navigator.share({
            title: 'Reporte de Solicitudes Crediticias',
            text: 'Vista completa de solicitudes del sistema',
            url: window.location.href
        });
    } else {
        // Fallback para navegadores que no soportan Web Share API
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert('URL copiada al portapapeles');
        });
    }
}

// Función para manejo de errores
function manejarError(error, mensaje = 'Ha ocurrido un error') {
    console.error('Error:', error);
    alert(`${mensaje}\n\nPor favor, contacte al administrador si el problema persiste.`);
}

// Función para validar datos antes de operaciones
function validarSeleccion() {
    if (solicitudesSeleccionadas.length === 0) {
        alert('Debe seleccionar al menos una solicitud.');
        return false;
    }
    return true;
}

// =================== FUNCIONES DE COMUNICACIÓN CON BACKEND ===================
async function obtenerDatosActualizados() {
    try {
        mostrarProgreso('Actualizando', 'Obteniendo datos más recientes...');
        
        const response = await fetch(window.location.href, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            throw new Error('Error al obtener datos actualizados');
        }
    } catch (error) {
        manejarError(error, 'Error al actualizar los datos');
    } finally {
        ocultarProgreso();
    }
}

async function exportarDatosBackend(formato, seleccionadas = []) {
    try {
        mostrarProgreso('Exportando', `Generando archivo ${formato.toUpperCase()}...`);
        
        const params = new URLSearchParams(window.location.search);
        if (seleccionadas.length > 0) {
            params.append('solicitudes_ids', seleccionadas.join(','));
        }
        params.append('formato', formato);
        
        const response = await fetch(`/exportar_solicitudes?${params.toString()}`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `solicitudes_${new Date().toISOString().split('T')[0]}.${formato}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } else {
            throw new Error('Error en la exportación');
        }
    } catch (error) {
        manejarError(error, 'Error al exportar los datos');
    } finally {
        ocultarProgreso();
    }
}

async function obtenerHistorialReal(solicitudId) {
    try {
        const response = await fetch(`/historial_solicitud/${solicitudId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const historial = await response.json();
            return historial;
        } else {
            throw new Error('Error al obtener historial');
        }
    } catch (error) {
        console.error('Error al obtener historial:', error);
        return null;
    }
}

// =================== FUNCIONES DE TECLADO ===================
document.addEventListener('keydown', function(event) {
    // Ctrl + F para búsqueda rápida
    if (event.ctrlKey && event.key === 'f') {
        event.preventDefault();
        busquedaRapida();
    }
    
    // Ctrl + A para seleccionar todo
    if (event.ctrlKey && event.key === 'a' && event.target.tagName !== 'INPUT') {
        event.preventDefault();
        document.getElementById('selectAll').checked = true;
        toggleSelectAll();
    }
    
    // Escape para limpiar búsqueda
    if (event.key === 'Escape') {
        if (ultimaBusqueda) {
            limpiarBusqueda();
        }
    }
    
    // Ctrl + E para exportar
    if (event.ctrlKey && event.key === 'e') {
        event.preventDefault();
        exportarDatos();
    }
    
    // F5 bloqueado, usar Ctrl + R para recargar
    if (event.key === 'F5') {
        event.preventDefault();
        if (confirm('¿Actualizar la página? Se perderán las selecciones actuales.')) {
            location.reload();
        }
    }
});

// =================== FUNCIONES DE FILTROS AVANZADOS ===================
function aplicarFiltroPersonalizado() {
    const filtros = {
        montoMin: prompt('Monto mínimo (dejar vacío para omitir):'),
        montoMax: prompt('Monto máximo (dejar vacío para omitir):'),
        ficoMin: prompt('FICO mínimo (dejar vacío para omitir):'),
        ficoMax: prompt('FICO máximo (dejar vacío para omitir):'),
        tdsrMax: prompt('TDSR máximo % (dejar vacío para omitir):')
    };
    
    // Construir URL con filtros
    const params = new URLSearchParams(window.location.search);
    
    Object.keys(filtros).forEach(key => {
        if (filtros[key] && filtros[key].trim()) {
            params.set(key, filtros[key].trim());
        }
    });
    
    window.location.href = `${window.location.pathname}?${params.toString()}`;
}

function guardarFiltroPersonalizado() {
    const nombreFiltro = prompt('Nombre para este filtro:');
    if (nombreFiltro) {
        const filtroActual = window.location.search;
        localStorage.setItem(`filtro_${nombreFiltro}`, filtroActual);
        alert(`Filtro "${nombreFiltro}" guardado exitosamente.`);
    }
}

function cargarFiltroGuardado() {
    const filtrosGuardados = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('filtro_')) {
            filtrosGuardados.push(key.substring(7));
        }
    }
    
    if (filtrosGuardados.length === 0) {
        alert('No hay filtros guardados.');
        return;
    }
    
    let mensaje = 'Filtros guardados:\n\n';
    filtrosGuardados.forEach((filtro, index) => {
        mensaje += `${index + 1}. ${filtro}\n`;
    });
    
    const seleccion = prompt(mensaje + '\nIngrese el número del filtro a cargar:');
    if (seleccion && seleccion >= 1 && seleccion <= filtrosGuardados.length) {
        const filtroSeleccionado = filtrosGuardados[seleccion - 1];
        const filtroQuery = localStorage.getItem(`filtro_${filtroSeleccionado}`);
        window.location.href = `${window.location.pathname}${filtroQuery}`;
    }
}

// =================== FUNCIONES DE ANÁLISIS AVANZADO ===================
function generarReporteComparativo() {
    if (!validarSeleccion()) return;
    
    const solicitudesData = obtenerDatosSolicitudesSeleccionadas();
    
    const reporteHTML = `
        <div class="row">
            <div class="col-12">
                <h5 class="mb-3">Reporte Comparativo de Solicitudes Seleccionadas</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Métrica</th>
                                <th>Promedio</th>
                                <th>Mínimo</th>
                                <th>Máximo</th>
                                <th>Desviación</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Monto Solicitado</strong></td>
                                <td>${solicitudesData.montoPromedio.toLocaleString()}</td>
                                <td>${solicitudesData.montoMin.toLocaleString()}</td>
                                <td>${solicitudesData.montoMax.toLocaleString()}</td>
                                <td>${solicitudesData.desviacionMonto.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td><strong>Score FICO</strong></td>
                                <td>${solicitudesData.ficoPromedio.toFixed(0)}</td>
                                <td>${solicitudesData.ficoMin}</td>
                                <td>${solicitudesData.ficoMax}</td>
                                <td>${solicitudesData.desviacionFico.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td><strong>TDSR (%)</strong></td>
                                <td>${solicitudesData.tdsrPromedio.toFixed(1)}%</td>
                                <td>${solicitudesData.tdsrMin}%</td>
                                <td>${solicitudesData.tdsrMax}%</td>
                                <td>${solicitudesData.desviacionTdsr.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">Distribución por Estado</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <span class="badge bg-success">${solicitudesData.aprobadas}</span> Aprobadas
                            <div class="progress mb-1" style="height: 10px;">
                                <div class="progress-bar bg-success" style="width: ${(solicitudesData.aprobadas/solicitudesData.total)*100}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <span class="badge bg-danger">${solicitudesData.rechazadas}</span> Rechazadas
                            <div class="progress mb-1" style="height: 10px;">
                                <div class="progress-bar bg-danger" style="width: ${(solicitudesData.rechazadas/solicitudesData.total)*100}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <span class="badge bg-warning">${solicitudesData.zonaGris}</span> Zona Gris
                            <div class="progress mb-1" style="height: 10px;">
                                <div class="progress-bar bg-warning" style="width: ${(solicitudesData.zonaGris/solicitudesData.total)*100}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">Recomendaciones</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            ${solicitudesData.recomendaciones.map(rec => `<li class="mb-2"><i class="fas fa-lightbulb text-warning me-2"></i>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('estadisticasContent').innerHTML = reporteHTML;
    new bootstrap.Modal(document.getElementById('estadisticasModal')).show();
}

function obtenerDatosSolicitudesSeleccionadas() {
    const filasSeleccionadas = solicitudesSeleccionadas.map(id => 
        document.querySelector(`tr[data-solicitud-id="${id}"]`)
    ).filter(fila => fila);
    
    let montos = [], ficos = [], tdsrs = [];
    let aprobadas = 0, rechazadas = 0, zonaGris = 0, pendientes = 0;
    
    filasSeleccionadas.forEach(fila => {
        // Extraer datos de cada fila
        const estado = fila.querySelector('.status-badge').textContent.trim();
        if (estado.includes('Aprobado')) aprobadas++;
        else if (estado.includes('Rechazado')) rechazadas++;
        else if (estado.includes('Zona Gris')) zonaGris++;
        else pendientes++;
        
        // Extraer montos
        const montoText = fila.cells[4].textContent;
        const montoMatch = montoText.match(/\$[\d,]+/);
        if (montoMatch) {
            montos.push(parseFloat(montoMatch[0].replace(/[$,]/g, '')));
        }
        
        // Extraer FICOs
        const ficoBadge = fila.cells[6].querySelector('.badge');
        if (ficoBadge) {
            ficos.push(parseInt(ficoBadge.textContent));
        }
        
        // Extraer TDSRs
        const tdsrBadge = fila.cells[7].querySelector('.badge');
        if (tdsrBadge) {
            tdsrs.push(parseFloat(tdsrBadge.textContent.replace('%', '')));
        }
    });
    
    // Calcular estadísticas
    const calcularEstadisticas = (arr) => {
        const promedio = arr.reduce((a, b) => a + b, 0) / arr.length;
        const min = Math.min(...arr);
        const max = Math.max(...arr);
        const desviacion = Math.sqrt(arr.reduce((sq, n) => sq + Math.pow(n - promedio, 2), 0) / arr.length);
        return { promedio, min, max, desviacion };
    };
    
    const statsMontos = calcularEstadisticas(montos);
    const statsFicos = calcularEstadisticas(ficos);
    const statsTdsrs = calcularEstadisticas(tdsrs);
    
    // Generar recomendaciones
    const recomendaciones = [];
    if (statsMontos.promedio > 100000) {
        recomendaciones.push('Portafolio de alto valor, considerar seguimiento especializado');
    }
    if (statsFicos.promedio < 650) {
        recomendaciones.push('Score FICO promedio bajo, revisar políticas de riesgo');
    }
    if (statsTdsrs.promedio > 35) {
        recomendaciones.push('TDSR promedio alto, evaluar capacidad de pago');
    }
    if (aprobadas / filasSeleccionadas.length > 0.8) {
        recomendaciones.push('Alta tasa de aprobación, perfil de clientes favorable');
    }
    
    return {
        total: filasSeleccionadas.length,
        aprobadas, rechazadas, zonaGris, pendientes,
        montoPromedio: statsMontos.promedio,
        montoMin: statsMontos.min,
        montoMax: statsMontos.max,
        desviacionMonto: statsMontos.desviacion,
        ficoPromedio: statsFicos.promedio,
        ficoMin: statsFicos.min,
        ficoMax: statsFicos.max,
        desviacionFico: statsFicos.desviacion,
        tdsrPromedio: statsTdsrs.promedio,
        tdsrMin: statsTdsrs.min,
        tdsrMax: statsTdsrs.max,
        desviacionTdsr: statsTdsrs.desviacion,
        recomendaciones
    };
}

// =================== FUNCIONES DE NOTIFICACIONES ===================
function mostrarNotificacion(tipo, titulo, mensaje) {
    const colores = {
        success: 'bg-success',
        error: 'bg-danger',
        warning: 'bg-warning',
        info: 'bg-info'
    };
    
    const iconos = {
        success: 'fas fa-check-circle',
        error: 'fas fa-times-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
    };
    
    const notificacion = document.createElement('div');
    notificacion.className = `toast align-items-center text-white ${colores[tipo]} border-0`;
    notificacion.setAttribute('role', 'alert');
    notificacion.style.position = 'fixed';
    notificacion.style.top = '20px';
    notificacion.style.right = '20px';
    notificacion.style.zIndex = '9999';
    
    notificacion.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="${iconos[tipo]} me-2"></i>
                <strong>${titulo}</strong><br>
                ${mensaje}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(notificacion);
    
    const toast = new bootstrap.Toast(notificacion, { delay: 5000 });
    toast.show();
    
    notificacion.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(notificacion);
    });
}

// =================== INICIALIZACIÓN FINAL ===================
// Verificar que todas las funciones estén disponibles
window.sistemaAnalisisCredito = {
    version: '1.0.0',
    funciones: {
        filtros: true,
        busqueda: true,
        seleccion: true,
        exportacion: true,
        estadisticas: true,
        historial: true
    },
    inicializado: true
};

console.log('✅ Sistema de Análisis Crediticio - Vista completa cargada exitosamente');
console.log('📊 Funcionalidades disponibles:', window.sistemaAnalisisCredito.funciones);
</script>
{% endblock %}iarFiltros() {
    window.location.href = '{{ url_for("todas_solicitudes") }}';
}

function filtrosRapidos() {
    const opciones = [
        { texto: 'Solicitudes de Hoy', filtro: '?fecha_desde=' + new Date().toISOString().split('T')[0] },
        { texto: 'Solicitudes Pendientes', filtro: '?decision=en_proceso' },
        { texto: 'Aprobadas Este Mes', filtro: '?decision=aprobado&fecha_desde=' + new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0] },
        { texto: 'Zona Gris', filtro: '?decision=zona_gris' },
        { texto: 'Montos Altos (>$100k)', filtro: '?monto_min=100000' }
    ];
    
    let mensaje = 'Seleccione un filtro rápido:\n\n';
    opciones.forEach((opcion, index) => {
        mensaje += `${index + 1}. ${opcion.texto}\n`;
    });
    
    const seleccion = prompt(mensaje + '\nIngrese el número (1-5):');
    if (seleccion && seleccion >= 1 && seleccion <= 5) {
        window.location.href = '{{ url_for("todas_solicitudes") }}' + opciones[seleccion - 1].filtro;
    }
}

// =================== FUNCIONES DE ORDENAMIENTO ===================
function ordenarPor(campo) {
    const tabla = document.getElementById('tablaSolicitudes');
    const tbody = tabla.querySelector('tbody');
    const filas = Array.from(tbody.querySelectorAll('tr'));
    
    // Determinar dirección del ordenamiento
    const direccion = tabla.dataset.sortDirection === 'asc' ? 'desc' : 'asc';
    tabla.dataset.sortDirection = direccion;
    tabla.dataset.sortField = campo;
    
    filas.sort((a, b) => {
        let valorA, valorB;
        
        switch(campo) {
            case 'numero':
                valorA = parseInt(a.cells[1].textContent.trim());
                valorB = parseInt(b.cells[1].textContent.trim());
                break;
            case 'cliente':
                valorA = a.cells[2].textContent.trim().toLowerCase();
                valorB = b.cells[2].textContent.trim().toLowerCase();
                break;
            case 'monto':
                valorA = parseFloat(a.cells[4].textContent.replace(/[$,]/g, '')) || 0;
                valorB = parseFloat(b.cells[4].textContent.replace(/[$,]/g, '')) || 0;
                break;
            case 'fecha':
                valorA = new Date(a.cells[8].textContent.trim());
                valorB = new Date(b.cells[8].textContent.trim());
                break;
            default:
                valorA = a.cells[1].textContent.trim().toLowerCase();
                valorB = b.cells[1].textContent.trim().toLowerCase();
        }
        
        if (direccion === 'asc') {
            return valorA > valorB ? 1 : valorA < valorB ? -1 : 0;
        } else {
            return valorA < valorB ? 1 : valorA > valorB ? -1 : 0;
        }
    });
    
    // Reordenar las filas
    filas.forEach(fila => tbody.appendChild(fila));
    
    // Actualizar indicadores visuales
    actualizarIndicadoresOrdenamiento(campo, direccion);
}

function actualizarIndicadoresOrdenamiento(campo, direccion) {
    // Limpiar indicadores previos
    document.querySelectorAll('th i.fas').forEach(icono => {
        icono.className = 'fas fa-sort';
    });
    
    // Agregar indicador al campo actual
    const th = document.querySelector(`th[onclick="ordenarPor('${campo}')"] i`);
    if (th) {
        th.className = direccion === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }
}

// =================== FUNCIONES DE SELECCIÓN ===================
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.solicitud-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    actualizarSeleccion();
}

function actualizarSeleccion() {
    const checkboxes = document.querySelectorAll('.solicitud-checkbox:checked');
    const count = checkboxes.length;
    
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('accionesMasivas').style.display = count > 0 ? 'block' : 'none';
    
    solicitudesSeleccionadas = Array.from(checkboxes).map(cb => cb.value);
    
    // Actualizar el checkbox "Seleccionar todo"
    const totalCheckboxes = document.querySelectorAll('.solicitud-checkbox').length;
    const selectAll = document.getElementById('selectAll');
    selectAll.indeterminate = count > 0 && count < totalCheckboxes;
    selectAll.checked = count === totalCheckboxes;
}

function limpiarSeleccion() {
    document.querySelectorAll('.solicitud-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    document.getElementById('selectAll').indeterminate = false;
    actualizarSeleccion();
}

// =================== FUNCIONES DE BÚSQUEDA ===================
function busquedaRapida() {
    const termino = prompt('Buscar por número, cliente, RFC o analista:');
    if (termino && termino.trim()) {
        ultimaBusqueda = termino.trim().toLowerCase();
        const rows = document.querySelectorAll('#tablaSolicitudes tbody tr');
        let encontrados = 0;
        
        // Limpiar búsquedas anteriores
        limpiarBusqueda();
        
        rows.forEach(row => {
            const texto = row.textContent.toLowerCase();
            if (texto.includes(ultimaBusqueda)) {
                row.style.display = '';
                row.classList.add('busqueda-resaltado');
                encontrados++;
            } else {
                row.style.display = 'none';
            }
        });
        
        if (encontrados === 0) {
            alert(`No se encontraron resultados para: "${termino}"`);
            limpiarBusqueda();
        } else {
            alert(`Se encontraron ${encontrados} resultados para: "${termino}"`);
            
            // Scroll al primer resultado
            const primerResultado = document.querySelector('.busqueda-resaltado');
            if (primerResultado) {
                primerResultado.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }
}

function limpiarBusqueda() {
    const rows = document.querySelectorAll('#tablaSolicitudes tbody tr');
    rows.forEach(row => {
        row.style.display = '';
        row.style.backgroundColor = '';
        row.classList.remove('busqueda-resaltado');
    });
    ultimaBusqueda = '';
}

// =================== FUNCIONES DE HISTORIAL ===================
function verHistorial(solicitudId) {
    // Simulación de datos del historial - en producción vendría del backend
    const historial = `
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-marker bg-primary"></div>
                <div class="timeline-content">
                    <h6 class="timeline-title">Solicitud Creada</h6>
                    <p class="timeline-time"><i class="fas fa-clock me-1"></i>28/01/2025 09:30 - Analista E001</p>
                    <p class="timeline-description">Solicitud registrada en el sistema con número SOL-${solicitudId.toString().padStart(6, '0')}</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-marker bg-info"></div>
                <div class="timeline-content">
                    <h6 class="timeline-title">Documentos Validados</h6>
                    <p class="timeline-time"><i class="fas fa-clock me-1"></i>28/01/2025 10:15 - Analista E001</p>
                    <p class="timeline-description">Documentos de identidad, comprobantes de ingresos y estados financieros validados correctamente</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-marker bg-warning"></div>
                <div class="timeline-content">
                    <h6 class="timeline-title">Scoring Calculado</h6>
                    <p class="timeline-time"><i class="fas fa-clock me-1"></i>28/01/2025 10:20 - Sistema Automático</p>
                    <p class="timeline-description">Score crediticio calculado: 340/450 puntos<br>
                    <small class="text-muted">FICO: 720, TDSR: 28%, Historial: Excelente</small></p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-marker bg-success"></div>
                <div class="timeline-content">
                    <h6 class="timeline-title">Decisión Tomada</h6>
                    <p class="timeline-time"><i class="fas fa-clock me-1"></i>28/01/2025 10:25 - Analista E001</p>
                    <p class="timeline-description">Solicitud aprobada por $45,000 MXN<br>
                    <small class="text-success">Tasa de interés: 12.5% anual</small></p>
                </div>
            </div>
        </div>
        
        <style>
        .timeline {
            position: relative;
            padding-left: 30px;
            margin-top: 20px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
        }
        .timeline-marker {
            position: absolute;
            left: -22px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #dee2e6;
        }
        .timeline-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }
        .timeline-title {
            margin-bottom: 5px;
            color: #495057;
            font-weight: 600;
        }
        .timeline-time {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 8px;
        }
        .timeline-description {
            margin-bottom: 0;
            color: #495057;
        }
        </style>
    `;
    
    document.getElementById('historialContent').innerHTML = historial;
    new bootstrap.Modal(document.getElementById('historialModal')).show();
}

// =================== FUNCIONES DE EXPORTACIÓN ===================
function exportarDatos() {
    const formatos = [
        { nombre: 'Excel (.xlsx)', extension: 'xlsx', icono: 'fas fa-file-excel' },
        { nombre: 'CSV (.csv)', extension: 'csv', icono: 'fas fa-file-csv' },
        { nombre: 'PDF (.pdf)', extension: 'pdf', icono: 'fas fa-file-pdf' },
        { nombre: 'JSON (.json)', extension: 'json', icono: 'fas fa-file-code' }
    ];
    
    let mensaje = 'Seleccione el formato de exportación:\n\n';
    formatos.forEach((formato, index) => {
        mensaje += `${index + 1}. ${formato.nombre}\n`;
    });
    
    const seleccion = prompt(mensaje + '\nIngrese el número (1-4):');
    if (seleccion && seleccion >= 1 && seleccion <= 4) {
        const formatoSeleccionado = formatos[seleccion - 1];
        mostrarProgreso('Exportando', `Generando archivo ${formatoSeleccionado.nombre}...`);
        
        // Simular exportación
        setTimeout(() => {
            ocultarProgreso();
            alert(`Archivo exportado exitosamente en formato ${formatoSeleccionado.nombre}`);
            // Aquí iría la lógica real de exportación
        }, 2000);
    }
}

function exportarSeleccionadas() {
    if (solicitudesSeleccionadas.length === 0) {
        alert('Seleccione al menos una solicitud para exportar.');
        return;
    }
    
    const confirmar = confirm(`¿Exportar ${solicitudesSeleccionadas.length} solicitudes seleccionadas?`);
    if (confirmar) {
        mostrarProgreso('Exportando', `Procesando ${solicitudesSeleccionadas.length} solicitudes...`);
        
        setTimeout(() => {
            ocultarProgreso();
            alert(`${solicitudesSeleccionadas.length} solicitudes exportadas exitosamente.`);
        }, 1500);
    }
}

// =================== FUNCIONES DE REPORTES ===================
function generarReporteMasivo() {
    if (solicitudesSeleccionadas.length === 0) {
        alert('Seleccione al menos una solicitud para generar el reporte.');
        return;
    }
    
    if (confirm(`¿Generar reporte consolidado de ${solicitudesSeleccionadas.length} solicitudes?`)) {
        mostrarProgreso('Generando Reporte', 'Analizando datos y generando gráficos...');
        
        setTimeout(() => {
            ocultarProgreso();
            alert('Reporte consolidado generado exitosamente.');
            // Aquí se abriría una nueva ventana/modal con el reporte
        }, 3000);
    }
}

function estadisticasRapidas() {
    const filas = document.querySelectorAll('#tablaSolicitudes tbody tr:not([style*="display: none"])');
    const stats = {
        total: filas.length,
        aprobadas: 0,
        rechazadas: 0,
        zonaGris: 0,
        pendientes: 0,
        montoTotal: 0,
        montoPromedio: 0,
        ficoPromedio: 0,
        tdsrPromedio: 0
    };
    
    let sumaFico = 0, sumaTdsr = 0, contadorFico = 0, contadorTdsr = 0;
    
    filas.forEach(fila => {
        const estado = fila.querySelector('.status-badge').textContent.trim();
        
        if (estado.includes('Aprobado')) stats.aprobadas++;
        else if (estado.includes('Rechazado')) stats.rechazadas++;
        else if (estado.includes('Zona Gris')) stats.zonaGris++;
        else stats.pendientes++;
        
        // Calcular montos
        const montoCell = fila.cells[4].textContent;
        const montoMatch = montoCell.match(/\$[\d,]+/);
        if (montoMatch) {
            const monto = parseFloat(montoMatch[0].replace(/[$,]/g, ''));
            if (!isNaN(monto)) stats.montoTotal += monto;
        }
        
        // Calcular FICO promedio
        const ficoCell = fila.cells[6];
        const ficoBadge = ficoCell.querySelector('.badge');
        if (ficoBadge) {
            const fico = parseInt(ficoBadge.textContent);
            if (!isNaN(fico)) {
                sumaFico += fico;
                contadorFico++;
            }
        }
        
        // Calcular TDSR promedio
        const tdsrCell = fila.cells[7];
        const tdsrBadge = tdsrCell.querySelector('.badge');
        if (tdsrBadge) {
            const tdsr = parseFloat(tdsrBadge.textContent.replace('%', ''));
            if (!isNaN(tdsr)) {
                sumaTdsr += tdsr;
                contadorTdsr++;
            }
        }
    });
    
    stats.montoPromedio = stats.total > 0 ? stats.montoTotal / stats.total : 0;
    stats.ficoPromedio = contadorFico > 0 ? sumaFico / contadorFico : 0;
    stats.tdsrPromedio = contadorTdsr > 0 ? sumaTdsr / contadorTdsr : 0;
    
    const tasaAprobacion = stats.total > 0 ? ((stats.aprobadas / stats.total) * 100).toFixed(1) : 0;
    const tasaRechazo = stats.total > 0 ? ((stats.rechazadas / stats.total) * 100).toFixed(1) : 0;
    
    const estadisticasHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Resumen General</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-primary">${stats.total}</h4>
                                <small>Total Solicitudes</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success">${tasaAprobacion}%</h4>
                                <small>Tasa Aprobación</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6"><strong>Aprobadas:</strong></div>
                            <div class="col-6 text-success">${stats.aprobadas} (${tasaAprobacion}%)</div>
                        </div>
                        <div class="row">
                            <div class="col-6"><strong>Rechazadas:</strong></div>
                            <div class="col-6 text-danger">${stats.rechazadas} (${tasaRechazo}%)</div>
                        </div>
                        <div class="row">
                            <div class="col-6"><strong>Zona Gris:</strong></div>
                            <div class="col-6 text-warning">${stats.zonaGris}</div>
                        </div>
                        <div class="row">
                            <div class="col-6"><strong>Pendientes:</strong></div>
                            <div class="col-6 text-info">${stats.pendientes}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Análisis Financiero</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <strong>Monto Total:</strong>
                                <h5 class="text-success">$${stats.montoTotal.toLocaleString('es-MX')}</h5>
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Monto Promedio:</strong>
                                <h6 class="text-primary">$${stats.montoPromedio.toLocaleString('es-MX', {maximumFractionDigits: 0})}</h6>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6"><strong>FICO Promedio:</strong></div>
                            <div class="col-6">
                                <span class="badge ${stats.ficoPromedio >= 700 ? 'bg-success' : stats.ficoPromedio >= 650 ? 'bg-warning' : 'bg-danger'}">
                                    ${stats.ficoPromedio.toFixed(0)}
                                </span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6"><strong>TDSR Promedio:</strong></div>
                            <div class="col-6">
                                <span class="badge ${stats.tdsrPromedio <= 30 ? 'bg-success' : stats.tdsrPromedio <= 35 ? 'bg-warning' : 'bg-danger'}">
                                    ${stats.tdsrPromedio.toFixed(1)}%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Insights y Recomendaciones</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            ${tasaAprobacion > 70 ? '<li class="text-success"><i class="fas fa-check-circle me-2"></i>Excelente tasa de aprobación, indicando buen perfil de solicitantes.</li>' : ''}
                            ${stats.zonaGris > stats.total * 0.2 ? '<li class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Alto porcentaje en zona gris, revisar criterios de evaluación.</li>' : ''}
                            ${stats.ficoPromedio < 650 ? '<li class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>FICO promedio bajo, considerar estrategias de mitigación de riesgo.</li>' : ''}
                            ${stats.tdsrPromedio > 35 ? '<li class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>TDSR promedio alto, revisar capacidad de pago.</li>' : ''}
                            <li class="text-info"><i class="fas fa-info-circle me-2"></i>Análisis basado en ${stats.total} solicitudes ${ultimaBusqueda ? 'filtradas' : 'totales'}.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('estadisticasContent').innerHTML = estadisticasHTML;
    new bootstrap.Modal(document.getElementById('estadisticasModal')).show();
}

// =================== FUNCIONES DE UTILIDAD ===================
function mostrarProgreso(titulo, mensaje) {
    // Crear modal de progreso si no existe
    let modalProgreso = document.getElementById('progresoModal');
    if (!modalProgreso) {
        const modalHTML = `
            <div class="modal fade" id="progresoModal" tabindex="-1" data-bs-backdrop="static">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                        <div class="modal-body text-center p-4">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <h6 id="progresoTitulo">${titulo}</h6>
                            <p id="progresoMensaje" class="text-muted mb-0">${mensaje}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modalProgreso = document.getElementById('progresoModal');
    } else {
        document.getElementById('progresoTitulo').textContent = titulo;
        document.getElementById('progresoMensaje').textContent = mensaje;
    }
    
    new bootstrap.Modal(modalProgreso).show();
}

function ocultarProgreso() {
    const modalProgreso = document.getElementById('progresoModal');
    if (modalProgreso) {
        bootstrap.Modal.getInstance(modalProgreso).hide();
    }
}

function formatearNumero(numero) {
    return new Intl.NumberFormat('es-MX').format(numero);
}

function formatearMoneda(monto) {
    return new Intl.NumberFormat('es-MX', {
        style: 'currency',
        currency: 'MXN'
    }).format(monto);
}

// =================== EVENTOS Y INICIALIZACIÓN ===================
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Agregar eventos a los checkboxes
    document.querySelectorAll('.solicitud-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', actualizarSeleccion);
    });
    
    // Auto-actualizar cada 30 segundos (opcional)
    // setInterval(function() {
    //     if (confirm('¿Actualizar datos?')) {
    //         location.reload();
    //     }
    // }, 30000);
    
    console.log('Sistema de Análisis Crediticio - Vista de Todas las Solicitudes cargada correctamente');
});

// =================== FUNCIONES ADICIONALES ===================
function verDetalleRapido(solicitudId) {
    // Función para mostrar detalles rápidos en un popover o modal pequeño
    const detalleHTML = `
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Solicitud #${solicitudId.toString().padStart(6, '0')}</h6>
            </div>
            <div class="card-body">
                <p><strong>Estado:</strong> <span class="badge bg-success">Aprobado</span></p>
                <p><strong>Monto:</strong> $45,000</p>
                <p><strong>Score:</strong> 340/450</p>
                <p><strong>Analista:</strong> E001</p>
            </div>
        </div>
    `;
    
    // Mostrar en un modal pequeño o tooltip
    alert('Detalle rápido - Funcionalidad en desarrollo');
}

function imprimirVista() {
    window.print();
}

function compartirVista() {
    if (navigator.share) {
        navigator.share({
            title: 'Reporte de Solicitudes Crediticias',
            text: 'Vista completa de solicitudes del sistema',
            url: window.location.href
        });
    } else {
        // Fallback para navegadores que no soportan Web Share API
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert('URL copiada al portapapeles');
        });
    }
}

// Función para manejo de errores
function manejarError(error, mensaje = 'Ha ocurrido un error') {
    console.error('Error:', error);
    alert(`${mensaje}\n\nPor favor, contacte al administrador si el problema persiste.`);
}

// Función para validar datos antes de operaciones
function validarSeleccion() {
    if (solicitudesSeleccionadas.length === 0) {
        alert('Debe seleccionar al menos una solicitud.');
        return false;
    }
    return true;
}

// =================== FUNCIONES DE COMUNICACIÓN CON BACKEND ===================
async function obtenerDatosActualizados() {
    try {
        mostrarProgreso('Actualizando', 'Obteniendo datos más recientes...');
        
        const response = await fetch(window.location.href, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            throw new Error('Error al obtener datos actualizados');
        }
    } catch (error) {
        manejarError(error, 'Error al actualizar los datos');
    } finally {
        ocultarProgreso();
    }
}

async function exportarDatosBackend(formato, seleccionadas = []) {
    try {
        mostrarProgreso('Exportando', `Generando archivo ${formato.toUpperCase()}...`);
        
        const params = new URLSearchParams(window.location.search);
        if (seleccionadas.length > 0) {
            params.append('solicitudes_ids', seleccionadas.join(','));
        }
        params.append('formato', formato);
        
        const response = await fetch(`/exportar_solicitudes?${params.toString()}`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `solicitudes_${new Date().toISOString().split('T')[0]}.${formato}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } else {
            throw new Error('Error en la exportación');
        }
    } catch (error) {
        manejarError(error, 'Error al exportar los datos');
    } finally {
        ocultarProgreso();
    }
}

async function obtenerHistorialReal(solicitudId) {
    try {
        const response = await fetch(`/historial_solicitud/${solicitudId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const historial = await response.json();
            return historial;
        } else {
            throw new Error('Error al obtener historial');
        }
    } catch (error) {
        console.error('Error al obtener historial:', error);
        return null;
    }
}

// =================== FUNCIONES DE TECLADO ===================
document.addEventListener('keydown', function(event) {
    // Ctrl + F para búsqueda rápida
    if (event.ctrlKey && event.key === 'f') {
        event.preventDefault();
        busquedaRapida();
    }
    
    // Ctrl + A para seleccionar todo
    if (event.ctrlKey && event.key === 'a' && event.target.tagName !== 'INPUT') {
        event.preventDefault();
        document.getElementById('selectAll').checked = true;
        toggleSelectAll();
    }
    
    // Escape para limpiar búsqueda
    if (event.key === 'Escape') {
        if (ultimaBusqueda) {
            limpiarBusqueda();
        }
    }
    
    // Ctrl + E para exportar
    if (event.ctrlKey && event.key === 'e') {
        event.preventDefault();
        exportarDatos();
    }
    
    // F5 bloqueado, usar Ctrl + R para recargar
    if (event.key === 'F5') {
        event.preventDefault();
        if (confirm('¿Actualizar la página? Se perderán las selecciones actuales.')) {
            location.reload();
        }
    }
});

// =================== FUNCIONES DE FILTROS AVANZADOS ===================
function aplicarFiltroPersonalizado() {
    const filtros = {
        montoMin: prompt('Monto mínimo (dejar vacío para omitir):'),
        montoMax: prompt('Monto máximo (dejar vacío para omitir):'),
        ficoMin: prompt('FICO mínimo (dejar vacío para omitir):'),
        ficoMax: prompt('FICO máximo (dejar vacío para omitir):'),
        tdsrMax: prompt('TDSR máximo % (dejar vacío para omitir):')
    };
    
    // Construir URL con filtros
    const params = new URLSearchParams(window.location.search);
    
    Object.keys(filtros).forEach(key => {
        if (filtros[key] && filtros[key].trim()) {
            params.set(key, filtros[key].trim());
        }
    });
    
    window.location.href = `${window.location.pathname}?${params.toString()}`;
}

function guardarFiltroPersonalizado() {
    const nombreFiltro = prompt('Nombre para este filtro:');
    if (nombreFiltro) {
        const filtroActual = window.location.search;
        localStorage.setItem(`filtro_${nombreFiltro}`, filtroActual);
        alert(`Filtro "${nombreFiltro}" guardado exitosamente.`);
    }
}

function cargarFiltroGuardado() {
    const filtrosGuardados = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('filtro_')) {
            filtrosGuardados.push(key.substring(7));
        }
    }
    
    if (filtrosGuardados.length === 0) {
        alert('No hay filtros guardados.');
        return;
    }
    
    let mensaje = 'Filtros guardados:\n\n';
    filtrosGuardados.forEach((filtro, index) => {
        mensaje += `${index + 1}. ${filtro}\n`;
    });
    
    const seleccion = prompt(mensaje + '\nIngrese el número del filtro a cargar:');
    if (seleccion && seleccion >= 1 && seleccion <= filtrosGuardados.length) {
        const filtroSeleccionado = filtrosGuardados[seleccion - 1];
        const filtroQuery = localStorage.getItem(`filtro_${filtroSeleccionado}`);
        window.location.href = `${window.location.pathname}${filtroQuery}`;
    }
}

// =================== FUNCIONES DE ANÁLISIS AVANZADO ===================
function generarReporteComparativo() {
    if (!validarSeleccion()) return;
    
    const solicitudesData = obtenerDatosSolicitudesSeleccionadas();
    
    const reporteHTML = `
        <div class="row">
            <div class="col-12">
                <h5 class="mb-3">Reporte Comparativo de Solicitudes Seleccionadas</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Métrica</th>
                                <th>Promedio</th>
                                <th>Mínimo</th>
                                <th>Máximo</th>
                                <th>Desviación</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Monto Solicitado</strong></td>
                                <td>$${solicitudesData.montoPromedio.toLocaleString()}</td>
                                <td>$${solicitudesData.montoMin.toLocaleString()}</td>
                                <td>$${solicitudesData.montoMax.toLocaleString()}</td>
                                <td>${solicitudesData.desviacionMonto.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td><strong>Score FICO</strong></td>
                                <td>${solicitudesData.ficoPromedio.toFixed(0)}</td>
                                <td>${solicitudesData.ficoMin}</td>
                                <td>${solicitudesData.ficoMax}</td>
                                <td>${solicitudesData.desviacionFico.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td><strong>TDSR (%)</strong></td>
                                <td>${solicitudesData.tdsrPromedio.toFixed(1)}%</td>
                                <td>${solicitudesData.tdsrMin}%</td>
                                <td>${solicitudesData.tdsrMax}%</td>
                                <td>${solicitudesData.desviacionTdsr.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">Distribución por Estado</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <span class="badge bg-success">${solicitudesData.aprobadas}</span> Aprobadas
                            <div class="progress mb-1" style="height: 10px;">
                                <div class="progress-bar bg-success" style="width: ${(solicitudesData.aprobadas/solicitudesData.total)*100}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <span class="badge bg-danger">${solicitudesData.rechazadas}</span> Rechazadas
                            <div class="progress mb-1" style="height: 10px;">
                                <div class="progress-bar bg-danger" style="width: ${(solicitudesData.rechazadas/solicitudesData.total)*100}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <span class="badge bg-warning">${solicitudesData.zonaGris}</span> Zona Gris
                            <div class="progress mb-1" style="height: 10px;">
                                <div class="progress-bar bg-warning" style="width: ${(solicitudesData.zonaGris/solicitudesData.total)*100}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">Recomendaciones</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            ${solicitudesData.recomendaciones.map(rec => `<li class="mb-2"><i class="fas fa-lightbulb text-warning me-2"></i>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('estadisticasContent').innerHTML = reporteHTML;
    new bootstrap.Modal(document.getElementById('estadisticasModal')).show();
}

function obtenerDatosSolicitudesSeleccionadas() {
    const filasSeleccionadas = solicitudesSeleccionadas.map(id => 
        document.querySelector(`tr[data-solicitud-id="${id}"]`)
    ).filter(fila => fila);
    
    let montos = [], ficos = [], tdsrs = [];
    let aprobadas = 0, rechazadas = 0, zonaGris = 0, pendientes = 0;
    
    filasSeleccionadas.forEach(fila => {
        // Extraer datos de cada fila
        const estado = fila.querySelector('.status-badge').textContent.trim();
        if (estado.includes('Aprobado')) aprobadas++;
        else if (estado.includes('Rechazado')) rechazadas++;
        else if (estado.includes('Zona Gris')) zonaGris++;
        else pendientes++;
        
        // Extraer montos
        const montoText = fila.cells[4].textContent;
        const montoMatch = montoText.match(/\$[\d,]+/);
        if (montoMatch) {
            montos.push(parseFloat(montoMatch[0].replace(/[$,]/g, '')));
        }
        
        // Extraer FICOs
        const ficoBadge = fila.cells[6].querySelector('.badge');
        if (ficoBadge) {
            ficos.push(parseInt(ficoBadge.textContent));
        }
        
        // Extraer TDSRs
        const tdsrBadge = fila.cells[7].querySelector('.badge');
        if (tdsrBadge) {
            tdsrs.push(parseFloat(tdsrBadge.textContent.replace('%', '')));
        }
    });
    
    // Calcular estadísticas
    const calcularEstadisticas = (arr) => {
        const promedio = arr.reduce((a, b) => a + b, 0) / arr.length;
        const min = Math.min(...arr);
        const max = Math.max(...arr);
        const desviacion = Math.sqrt(arr.reduce((sq, n) => sq + Math.pow(n - promedio, 2), 0) / arr.length);
        return { promedio, min, max, desviacion };
    };
    
    const statsMontos = calcularEstadisticas(montos);
    const statsFicos = calcularEstadisticas(ficos);
    const statsTdsrs = calcularEstadisticas(tdsrs);
    
    // Generar recomendaciones
    const recomendaciones = [];
    if (statsMontos.promedio > 100000) {
        recomendaciones.push('Portafolio de alto valor, considerar seguimiento especializado');
    }
    if (statsFicos.promedio < 650) {
        recomendaciones.push('Score FICO promedio bajo, revisar políticas de riesgo');
    }
    if (statsTdsrs.promedio > 35) {
        recomendaciones.push('TDSR promedio alto, evaluar capacidad de pago');
    }
    if (aprobadas / filasSeleccionadas.length > 0.8) {
        recomendaciones.push('Alta tasa de aprobación, perfil de clientes favorable');
    }
    
    return {
        total: filasSeleccionadas.length,
        aprobadas, rechazadas, zonaGris, pendientes,
        montoPromedio: statsMontos.promedio,
        montoMin: statsMontos.min,
        montoMax: statsMontos.max,
        desviacionMonto: statsMontos.desviacion,
        ficoPromedio: statsFicos.promedio,
        ficoMin: statsFicos.min,
        ficoMax: statsFicos.max,
        desviacionFico: statsFicos.desviacion,
        tdsrPromedio: statsTdsrs.promedio,
        tdsrMin: statsTdsrs.min,
        tdsrMax: statsTdsrs.max,
        desviacionTdsr: statsTdsrs.desviacion,
        recomendaciones
    };
}

// =================== FUNCIONES DE NOTIFICACIONES ===================
function mostrarNotificacion(tipo, titulo, mensaje) {
    const colores = {
        success: 'bg-success',
        error: 'bg-danger',
        warning: 'bg-warning',
        info: 'bg-info'
    };
    
    const iconos = {
        success: 'fas fa-check-circle',
        error: 'fas fa-times-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
    };
    
    const notificacion = document.createElement('div');
    notificacion.className = `toast align-items-center text-white ${colores[tipo]} border-0`;
    notificacion.setAttribute('role', 'alert');
    notificacion.style.position = 'fixed';
    notificacion.style.top = '20px';
    notificacion.style.right = '20px';
    notificacion.style.zIndex = '9999';
    
    notificacion.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="${iconos[tipo]} me-2"></i>
                <strong>${titulo}</strong><br>
                ${mensaje}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(notificacion);
    
    const toast = new bootstrap.Toast(notificacion, { delay: 5000 });
    toast.show();
    
    notificacion.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(notificacion);
    });
}

// =================== FUNCIONES DE MONITOREO Y LOGS ===================
function registrarAccion(accion, detalles = '') {
    const timestamp = new Date().toISOString();
    const logEntry = {
        timestamp,
        accion,
        detalles,
        usuario: 'usuario_actual', // En producción vendría del sistema de autenticación
        url: window.location.href
    };
    
    console.log('📊 Acción registrada:', logEntry);
    
    // En producción, enviar al servidor
    // fetch('/api/log_accion', {
    //     method: 'POST',
    //     headers: { 'Content-Type': 'application/json' },
    //     body: JSON.stringify(logEntry)
    // });
}

function generarIdSesion() {
    return 'sess_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

// =================== FUNCIONES DE PERFORMANCE ===================
function optimizarTabla() {
    const tabla = document.getElementById('tablaSolicitudes');
    const filas = tabla.querySelectorAll('tbody tr');
    
    // Virtualización básica para tablas grandes
    if (filas.length > 100) {
        console.log('Aplicando optimización para tabla grande...');
        
        // Ocultar filas que no están en el viewport
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.display = '';
                } else {
                    // Mantener visible si está seleccionada
                    const checkbox = entry.target.querySelector('.solicitud-checkbox');
                    if (!checkbox || !checkbox.checked) {
                        entry.target.style.display = 'none';
                    }
                }
            });
        }, {
            rootMargin: '100px'
        });
        
        filas.forEach(fila => observer.observe(fila));
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// =================== FUNCIONES DE ACCESIBILIDAD ===================
function mejorarAccesibilidad() {
    // Agregar aria-labels dinámicos
    document.querySelectorAll('.status-badge').forEach(badge => {
        const estado = badge.textContent.trim();
        badge.setAttribute('aria-label', `Estado de solicitud: ${estado}`);
    });
    
    // Mejorar navegación por teclado
    document.querySelectorAll('.btn').forEach(btn => {
        if (!btn.hasAttribute('aria-label') && !btn.hasAttribute('title')) {
            const icon = btn.querySelector('i');
            if (icon) {
                const accion = btn.textContent.trim() || 'Acción';
                btn.setAttribute('aria-label', accion);
            }
        }
    });
    
    // Agregar skip links
    if (!document.querySelector('.skip-link')) {
        const skipLink = document.createElement('a');
        skipLink.href = '#tablaSolicitudes';
        skipLink.textContent = 'Saltar a la tabla de solicitudes';
        skipLink.className = 'skip-link sr-only';
        skipLink.style.position = 'absolute';
        skipLink.style.top = '-40px';
        skipLink.style.left = '6px';
        skipLink.style.background = '#000';
        skipLink.style.color = '#fff';
        skipLink.style.padding = '8px';
        skipLink.style.textDecoration = 'none';
        skipLink.style.zIndex = '100000';
        
        skipLink.addEventListener('focus', () => {
            skipLink.style.top = '6px';
        });
        
        skipLink.addEventListener('blur', () => {
            skipLink.style.top = '-40px';
        });
        
        document.body.insertBefore(skipLink, document.body.firstChild);
    }
}

// =================== INICIALIZACIÓN FINAL ===================
// Verificar que todas las funciones estén disponibles
window.sistemaAnalisisCredito = {
    version: '1.0.0',
    funciones: {
        filtros: true,
        busqueda: true,
        seleccion: true,
        exportacion: true,
        estadisticas: true,
        historial: true,
        accesibilidad: true,
        performance: true
    },
    inicializado: true,
    sesionId: generarIdSesion()
};

// Ejecutar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    // Mejorar accesibilidad
    mejorarAccesibilidad();
    
    // Optimizar tabla si es necesaria
    optimizarTabla();
    
    // Registrar inicio de sesión
    registrarAccion('vista_cargada', 'Vista de todas las solicitudes iniciada');
    
    console.log('✅ Sistema de Análisis Crediticio - Vista completa cargada exitosamente');
    console.log('📊 Funcionalidades disponibles:', window.sistemaAnalisisCredito.funciones);
    console.log('🆔 Sesión ID:', window.sistemaAnalisisCredito.sesionId);
});

// Event listener para el beforeunload
window.addEventListener('beforeunload', function() {
    registrarAccion('vista_cerrada', 'Usuario saliendo de la vista de solicitudes');
});

// Manejo global de errores JavaScript
window.addEventListener('error', function(event) {
    console.error('Error global capturado:', event.error);
    registrarAccion('error_javascript', `${event.error.message} en ${event.filename}:${event.lineno}`);
});

// Función de limpieza para evitar memory leaks
function limpiarRecursos() {
    // Limpiar timers si existen
    if (window.sistemaAnalisisCredito && window.sistemaAnalisisCredito.timers) {
        window.sistemaAnalisisCredito.timers.forEach(timer => clearTimeout(timer));
    }
    
    // Limpiar event listeners si es necesario
    console.log('🧹 Recursos limpiados correctamente');
}

// Detectar si el usuario está inactivo
let tiempoInactividad = 0;
const TIEMPO_MAX_INACTIVIDAD = 30 * 60 * 1000; // 30 minutos

function resetearTiempoInactividad() {
    tiempoInactividad = 0;
}

function verificarInactividad() {
    tiempoInactividad += 1000;
    if (tiempoInactividad >= TIEMPO_MAX_INACTIVIDAD) {
        mostrarNotificacion('warning', 'Sesión inactiva', 'Su sesión ha estado inactiva por mucho tiempo. Considere actualizar los datos.');
        tiempoInactividad = 0;
    }
}

// Event listeners para detectar actividad
['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
    document.addEventListener(event, resetearTiempoInactividad, true);
});

// Verificar inactividad cada minuto
setInterval(verificarInactividad, 60000);

console.log('🎯 Sistema de Análisis Crediticio completamente inicializado y listo para uso');

// =================== FUNCIONES DE EXPORTACIÓN MEJORADAS ===================
function exportarDatosAvanzado() {
    const opciones = {
        excel: { nombre: 'Excel (.xlsx)', icono: 'fas fa-file-excel', color: 'success' },
        csv: { nombre: 'CSV (.csv)', icono: 'fas fa-file-csv', color: 'info' },
        pdf: { nombre: 'PDF (.pdf)', icono: 'fas fa-file-pdf', color: 'danger' },
        json: { nombre: 'JSON (.json)', icono: 'fas fa-file-code', color: 'warning' }
    };
    
    let modalHTML = `
        <div class="modal fade" id="exportModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-download me-2"></i>Exportar Solicitudes
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">Seleccione el formato de exportación:</p>
                        <div class="row">
    `;
    
    Object.keys(opciones).forEach(formato => {
        const opcion = opciones[formato];
        modalHTML += `
            <div class="col-6 mb-3">
                <button class="btn btn-outline-${opcion.color} w-100 h-100 export-option" 
                        data-formato="${formato}">
                    <i class="${opcion.icono} fa-2x d-block mb-2"></i>
                    ${opcion.nombre}
                </button>
            </div>
        `;
    });
    
    modalHTML += `
                        </div>
                        <hr>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="incluirFiltros">
                            <label class="form-check-label" for="incluirFiltros">
                                Incluir filtros actuales
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="soloSeleccionadas">
                            <label class="form-check-label" for="soloSeleccionadas">
                                Solo solicitudes seleccionadas (${solicitudesSeleccionadas.length})
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente si existe
    const modalExistente = document.getElementById('exportModal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Agregar event listeners
    document.querySelectorAll('.export-option').forEach(btn => {
        btn.addEventListener('click', function() {
            const formato = this.dataset.formato;
            const incluirFiltros = document.getElementById('incluirFiltros').checked;
            const soloSeleccionadas = document.getElementById('soloSeleccionadas').checked;
            
            bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
            
            ejecutarExportacion(formato, {
                incluirFiltros,
                soloSeleccionadas,
                solicitudesIds: soloSeleccionadas ? solicitudesSeleccionadas : []
            });
        });
    });
    
    new bootstrap.Modal(document.getElementById('exportModal')).show();
}

function ejecutarExportacion(formato, opciones) {
    registrarAccion('exportacion_iniciada', `Formato: ${formato}, Opciones: ${JSON.stringify(opciones)}`);
    
    mostrarProgreso('Exportando', `Generando archivo ${formato.toUpperCase()}...`);
    
    // Simular proceso de exportación
    const tiempoSimulacion = 2000 + (opciones.solicitudesIds.length * 10);
    
    setTimeout(() => {
        ocultarProgreso();
        mostrarNotificacion('success', 'Exportación Completada', 
            `Archivo ${formato.toUpperCase()} generado exitosamente`);
        
        registrarAccion('exportacion_completada', `Formato: ${formato}`);
        
        // En producción, aquí se haría la descarga real
        console.log(`Exportación simulada: ${formato}`, opciones);
    }, tiempoSimulacion);
}

// =================== FUNCIONES DE AYUDA Y DOCUMENTACIÓN ===================
function mostrarAyuda() {
    const ayudaHTML = `
        <div class="row">
            <div class="col-12">
                <h5 class="mb-3">
                    <i class="fas fa-question-circle me-2"></i>
                    Guía de Uso - Vista de Solicitudes
                </h5>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card border-primary mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">⌨️ Atajos de Teclado</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li><kbd>Ctrl + F</kbd> - Búsqueda rápida</li>
                            <li><kbd>Ctrl + A</kbd> - Seleccionar todo</li>
                            <li><kbd>Ctrl + E</kbd> - Exportar datos</li>
                            <li><kbd>Escape</kbd> - Limpiar búsqueda</li>
                            <li><kbd>F5</kbd> - Actualizar (con confirmación)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="card border-info mb-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">🔍 Funciones de Búsqueda</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li>• Buscar por número de solicitud</li>
                            <li>• Buscar por nombre del cliente</li>
                            <li>• Buscar por RFC</li>
                            <li>• Buscar por código de analista</li>
                            <li>• Filtros por fecha, monto, estado</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card border-success mb-3">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">📊 Estados de Solicitudes</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li><span class="badge bg-success me-2">Aprobado</span> Solicitud aprobada</li>
                            <li><span class="badge bg-danger me-2">Rechazado</span> Solicitud rechazada</li>
                            <li><span class="badge bg-warning me-2">Zona Gris</span> Requiere revisión</li>
                            <li><span class="badge bg-info me-2">En Proceso</span> En evaluación</li>
                        </ul>
                    </div>
                </div>
                
                <div class="card border-warning mb-3">
                    <div class="card-header bg-warning text-white">
                        <h6 class="mb-0">⚠️ Indicadores de Riesgo</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li><span class="badge bg-success me-2">FICO ≥700</span> Bajo riesgo</li>
                            <li><span class="badge bg-warning me-2">FICO 650-699</span> Riesgo medio</li>
                            <li><span class="badge bg-danger me-2">FICO <650</span> Alto riesgo</li>
                            <li><span class="badge bg-success me-2">TDSR ≤30%</span> Capacidad buena</li>
                            <li><span class="badge bg-danger me-2">TDSR >35%</span> Capacidad limitada</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card border-secondary">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">🎯 Consejos y Mejores Prácticas</h6>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0">
                            <li><strong>Filtros Eficientes:</strong> Use filtros combinados para encontrar solicitudes específicas más rápido</li>
                            <li><strong>Selección Masiva:</strong> Seleccione múltiples solicitudes para operaciones en lote</li>
                            <li><strong>Exportación:</strong> Use filtros antes de exportar para obtener solo los datos necesarios</li>
                            <li><strong>Búsqueda:</strong> La búsqueda resalta los resultados para fácil identificación</li>
                            <li><strong>Estadísticas:</strong> Use el botón "Stats" para obtener análisis rápidos de los datos visibles</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('estadisticasContent').innerHTML = ayudaHTML;
    document.querySelector('#estadisticasModal .modal-title').innerHTML = 
        '<i class="fas fa-question-circle me-2"></i>Ayuda del Sistema';
    new bootstrap.Modal(document.getElementById('estadisticasModal')).show();
}

// =================== FUNCIONES DE CONFIGURACIÓN ===================
function configurarVista() {
    const configHTML = `
        <div class="row">
            <div class="col-12">
                <h5 class="mb-3">
                    <i class="fas fa-cog me-2"></i>
                    Configuración de Vista
                </h5>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">📋 Configuración de Tabla</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="mostrarFechaCompleta" ${localStorage.getItem('mostrarFechaCompleta') === 'true' ? 'checked' : ''}>
                            <label class="form-check-label" for="mostrarFechaCompleta">
                                Mostrar fecha completa
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="compactarFilas" ${localStorage.getItem('compactarFilas') === 'true' ? 'checked' : ''}>
                            <label class="form-check-label" for="compactarFilas">
                                Vista compacta
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="autoActualizar" ${localStorage.getItem('autoActualizar') === 'true' ? 'checked' : ''}>
                            <label class="form-check-label" for="autoActualizar">
                                Auto-actualizar cada 5 minutos
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">🎨 Personalización</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Filas por página:</label>
                            <select class="form-select" id="filasPorPagina">
                                <option value="10" ${localStorage.getItem('filasPorPagina') === '10' ? 'selected' : ''}>10</option>
                                <option value="25" ${localStorage.getItem('filasPorPagina') === '25' ? 'selected' : ''}>25</option>
                                <option value="50" ${localStorage.getItem('filasPorPagina') === '50' ? 'selected' : ''}>50</option>
                                <option value="100" ${localStorage.getItem('filasPorPagina') === '100' ? 'selected' : ''}>100</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Orden por defecto:</label>
                            <select class="form-select" id="ordenDefecto">
                                <option value="fecha_desc" ${localStorage.getItem('ordenDefecto') === 'fecha_desc' ? 'selected' : ''}>Fecha (más reciente)</option>
                                <option value="fecha_asc" ${localStorage.getItem('ordenDefecto') === 'fecha_asc' ? 'selected' : ''}>Fecha (más antigua)</option>
                                <option value="numero_desc" ${localStorage.getItem('ordenDefecto') === 'numero_desc' ? 'selected' : ''}>Número (descendente)</option>
                                <option value="numero_asc" ${localStorage.getItem('ordenDefecto') === 'numero_asc' ? 'selected' : ''}>Número (ascendente)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="restablecerConfiguracion()">
                        <i class="fas fa-undo me-2"></i>Restablecer
                    </button>
                    <button class="btn btn-primary" onclick="aplicarConfiguracion()">
                        <i class="fas fa-save me-2"></i>Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('estadisticasContent').innerHTML = configHTML;
    document.querySelector('#estadisticasModal .modal-title').innerHTML = 
        '<i class="fas fa-cog me-2"></i>Configuración';
    new bootstrap.Modal(document.getElementById('estadisticasModal')).show();
}

function aplicarConfiguracion() {
    const configuraciones = {
        mostrarFechaCompleta: document.getElementById('mostrarFechaCompleta').checked,
        compactarFilas: document.getElementById('compactarFilas').checked,
        autoActualizar: document.getElementById('autoActualizar').checked,
        filasPorPagina: document.getElementById('filasPorPagina').value,
        ordenDefecto: document.getElementById('ordenDefecto').value
    };
    
    // Guardar en localStorage
    Object.keys(configuraciones).forEach(key => {
        localStorage.setItem(key, configuraciones[key]);
    });
    
    // Aplicar cambios inmediatamente
    aplicarEstilosPersonalizados(configuraciones);
    
    bootstrap.Modal.getInstance(document.getElementById('estadisticasModal')).hide();
    mostrarNotificacion('success', 'Configuración Guardada', 'Los cambios se han aplicado correctamente');
    
    registrarAccion('configuracion_aplicada', JSON.stringify(configuraciones));
}

function aplicarEstilosPersonalizados(config) {
    const tabla = document.getElementById('tablaSolicitudes');
    
    if (config.compactarFilas) {
        tabla.classList.add('table-sm');
    } else {
        tabla.classList.remove('table-sm');
    }
    
    // Aplicar otras configuraciones...
}

function restablecerConfiguracion() {
    if (confirm('¿Está seguro de que desea restablecer toda la configuración?')) {
        localStorage.removeItem('mostrarFechaCompleta');
        localStorage.removeItem('compactarFilas');
        localStorage.removeItem('autoActualizar');
        localStorage.removeItem('filasPorPagina');
        localStorage.removeItem('ordenDefecto');
        
        mostrarNotificacion('info', 'Configuración Restablecida', 'Se han restaurado los valores por defecto');
        registrarAccion('configuracion_restablecida', 'Usuario restableció configuración');
        
        // Recargar la página para aplicar cambios
        setTimeout(() => location.reload(), 1000);
    }
}

// =================== CIERRE Y CLEANUP ===================
// Agregar funciones al objeto global para debugging
window.sistemaAnalisisCredito.funciones.exportarAvanzado = exportarDatosAvanzado;
window.sistemaAnalisisCredito.funciones.mostrarAyuda = mostrarAyuda;
window.sistemaAnalisisCredito.funciones.configurarVista = configurarVista;

// Event listeners adicionales
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        registrarAccion('pestaña_oculta', 'Usuario cambió a otra pestaña');
    } else {
        registrarAccion('pestaña_visible', 'Usuario regresó a la pestaña');
    }
});

// Limpieza final cuando se cierre la página
window.addEventListener('beforeunload', function() {
    limpiarRecursos();
});

console.log('🎉 Sistema de Análisis Crediticio - COMPLETAMENTE CARGADO Y FUNCIONAL');
console.log('📝 Total de funciones disponibles:', Object.keys(window.sistemaAnalisisCredito.funciones).length);
console.log('🔧 Para debugging, use: window.sistemaAnalisisCredito');

</script>
{% endblock %}
