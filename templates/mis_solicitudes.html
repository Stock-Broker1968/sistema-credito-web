{% extends "base.html" %}

{% block title %}Mis Solicitudes - Sistema de Análisis Crediticio{% endblock %}

{% block extra_css %}
<style>
    .status-badge {
        font-size: 0.8em;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: bold;
    }
    
    .status-aprobado { background: #d4edda; color: #155724; }
    .status-rechazado { background: #f8d7da; color: #721c24; }
    .status-zona_gris { background: #fff3cd; color: #856404; }
    .status-en_proceso { background: #d1ecf1; color: #0c5460; }
    
    .table-hover tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.1);
    }
    
    .filter-card {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .stats-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .action-buttons .btn {
        margin: 2px;
    }
    
    @media (max-width: 768px) {
        .table-responsive {
            font-size: 0.9em;
        }
        
        .action-buttons .btn {
            padding: 4px 8px;
            font-size: 0.8em;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card card-custom">
                <div class="card-body">
                    <h6><i class="fas fa-dollar-sign me-2"></i>Montos Procesados</h6>
                    <div class="row text-center">
                        <div class="col-6">
                            <strong class="text-primary">
                                ${{ "{:,.0f}".format(solicitudes.items | selectattr('monto_solicitado') | map(attribute='monto_solicitado') | sum) }}
                            </strong><br>
                            <small>Total Solicitado</small>
                        </div>
                        <div class="col-6">
                            <strong class="text-success">
                                ${{ "{:,.0f}".format(solicitudes.items | selectattr('monto_aprobado') | map(attribute='monto_aprobado') | sum) }}
                            </strong><br>
                            <small>Total Aprobado</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function duplicarSolicitud(solicitudId) {
    if (confirm('¿Desea crear una nueva solicitud basada en los datos de esta solicitud?')) {
        // Redirigir a nueva solicitud con parámetros para pre-llenar
        window.location.href = `{{ url_for('nueva_solicitud') }}?duplicar=${solicitudId}`;
    }
}

// Función para exportar datos
function exportarSolicitudes() {
    const filtros = new URLSearchParams(window.location.search);
    window.open(`{{ url_for('exportar_solicitudes') }}?${filtros.toString()}`, '_blank');
}

// Auto-submit de filtros con delay
let filterTimeout;
document.querySelectorAll('select[name="estado"], input[name="fecha_desde"], input[name="fecha_hasta"]').forEach(element => {
    element.addEventListener('change', function() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => {
            this.form.submit();
        }, 500);
    });
});

// Actualización automática cada 5 minutos
setInterval(function() {
    if (document.visibilityState === 'visible') {
        window.location.reload();
    }
}, 300000);

// Marcar como leído al hacer clic en una solicitud
document.querySelectorAll('a[href*="ver_solicitud"], a[href*="evaluar_solicitud"], a[href*="resultado_solicitud"]').forEach(link => {
    link.addEventListener('click', function() {
        const row = this.closest('tr');
        row.style.opacity = '0.7';
    });
});

// Tooltips para los badges de estado
document.addEventListener('DOMContentLoaded', function() {
    // Agregar tooltips informativos
    document.querySelectorAll('.badge').forEach(badge => {
        const value = badge.textContent.trim();
        let tooltip = '';
        
        if (value.includes('FICO')) {
            const score = parseInt(value);
            if (score >= 700) {
                tooltip = 'Excelente historial crediticio';
            } else if (score >= 650) {
                tooltip = 'Buen historial crediticio';
            } else {
                tooltip = 'Historial crediticio mejorable';
            }
        } else if (value.includes('%')) {
            const tdsr = parseFloat(value);
            if (tdsr <= 30) {
                tooltip = 'Bajo nivel de endeudamiento';
            } else if (tdsr <= 35) {
                tooltip = 'Nivel de endeudamiento moderado';
            } else {
                tooltip = 'Alto nivel de endeudamiento';
            }
        }
        
        if (tooltip) {
            badge.title = tooltip;
        }
    });

    // Agregar indicador de solicitudes nuevas/actualizadas
    const solicitudesRecientes = document.querySelectorAll('tbody tr');
    solicitudesRecientes.forEach((row, index) => {
        const fechaCell = row.querySelector('td:nth-last-child(2)');
        if (fechaCell) {
            const fechaTexto = fechaCell.textContent.trim();
            const hoy = new Date();
            const fecha = new Date(fechaTexto.split('/').reverse().join('-'));
            
            // Si la solicitud es de hoy, agregar indicador
            if (fecha.toDateString() === hoy.toDateString()) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-info ms-2';
                badge.innerHTML = '<i class="fas fa-star"></i> Nuevo';
                badge.style.fontSize = '0.7em';
                fechaCell.appendChild(badge);
            }
        }
    });
});

// Función para búsqueda rápida
function busquedaRapida() {
    const searchTerm = prompt('Buscar por RFC, nombre o número de solicitud:');
    if (searchTerm) {
        const rows = document.querySelectorAll('tbody tr');
        let found = false;
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm.toLowerCase())) {
                row.style.backgroundColor = '#fff3cd';
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                found = true;
            } else {
                row.style.backgroundColor = '';
            }
        });
        
        if (!found) {
            alert('No se encontraron resultados para: ' + searchTerm);
        }
    }
}

// Agregar botón de búsqueda rápida
document.addEventListener('DOMContentLoaded', function() {
    const header = document.querySelector('.card-header .row .col-md-6:last-child');
    if (header) {
        const searchBtn = document.createElement('button');
        searchBtn.className = 'btn btn-sm btn-outline-secondary ms-2';
        searchBtn.innerHTML = '<i class="fas fa-search"></i>';
        searchBtn.title = 'Búsqueda rápida';
        searchBtn.onclick = busquedaRapida;
        header.appendChild(searchBtn);
    }
});

// Función para estadísticas rápidas
function mostrarEstadisticas() {
    const rows = document.querySelectorAll('tbody tr');
    const stats = {
        total: rows.length,
        aprobadas: 0,
        rechazadas: 0,
        pendientes: 0,
        montoTotal: 0,
        montoAprobado: 0
    };
    
    rows.forEach(row => {
        const estado = row.querySelector('.status-badge').textContent.trim();
        const montoSol = row.cells[3].textContent.replace(/[$,]/g, '').trim();
        const montoApr = row.cells[4].textContent.replace(/[$,]/g, '').trim();
        
        if (estado.includes('Aprobado')) stats.aprobadas++;
        else if (estado.includes('Rechazado')) stats.rechazadas++;
        else stats.pendientes++;
        
        if (montoSol && !isNaN(parseFloat(montoSol))) {
            stats.montoTotal += parseFloat(montoSol);
        }
        
        if (montoApr && !isNaN(parseFloat(montoApr))) {
            stats.montoAprobado += parseFloat(montoApr);
        }
    });
    
    const tasaAprobacion = stats.total > 0 ? ((stats.aprobadas / stats.total) * 100).toFixed(1) : 0;
    
    alert(`Estadísticas de la página actual:
    
Total: ${stats.total} solicitudes
Aprobadas: ${stats.aprobadas} (${tasaAprobacion}%)
Rechazadas: ${stats.rechazadas}
Pendientes: ${stats.pendientes}

Monto total solicitado: ${stats.montoTotal.toLocaleString()}
Monto total aprobado: ${stats.montoAprobado.toLocaleString()}`);
}

// Atajos de teclado
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey) {
        switch(e.key) {
            case 'f':
                e.preventDefault();
                busquedaRapida();
                break;
            case 'n':
                e.preventDefault();
                window.location.href = '{{ url_for("nueva_solicitud") }}';
                break;
            case 's':
                e.preventDefault();
                mostrarEstadisticas();
                break;
        }
    }
});

// Mostrar ayuda de atajos
function mostrarAyuda() {
    alert(`Atajos de teclado disponibles:

Ctrl + F: Búsqueda rápida
Ctrl + N: Nueva solicitud
Ctrl + S: Mostrar estadísticas

Clic en cualquier solicitud para ver detalles.
Los badges de colores indican el nivel de riesgo.`);
}

// Agregar botón de ayuda
document.addEventListener('DOMContentLoaded', function() {
    const helpBtn = document.createElement('button');
    helpBtn.className = 'btn btn-sm btn-outline-info position-fixed';
    helpBtn.style.bottom = '20px';
    helpBtn.style.right = '20px';
    helpBtn.style.zIndex = '1000';
    helpBtn.innerHTML = '<i class="fas fa-question"></i>';
    helpBtn.title = 'Ayuda y atajos';
    helpBtn.onclick = mostrarAyuda;
    document.body.appendChild(helpBtn);
});
</script>
{% endblock %}12">
            <div class="card card-custom">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="mb-1">
                                <i class="fas fa-folder-open text-primary me-3"></i>
                                Mis Solicitudes de Crédito
                            </h1>
                            <p class="text-muted mb-0">
                                Analista: <strong>{{ session.analista_nombre }}</strong> ({{ session.analista_codigo }})
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{{ url_for('nueva_solicitud') }}" class="btn btn-primary me-2">
                                <i class="fas fa-plus me-2"></i>Nueva Solicitud
                            </a>
                            <a href="{{ url_for('captura_analista') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen de Estadísticas -->
    <div class="stats-summary">
        <div class="row text-center">
            <div class="col-md-3 mb-3 mb-md-0">
                <h3>{{ solicitudes.total }}</h3>
                <p class="mb-0">Total de Solicitudes</p>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
                <h3>{{ solicitudes.items | selectattr('decision', 'equalto', 'aprobado') | list | length }}</h3>
                <p class="mb-0">Aprobadas</p>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
                <h3>{{ solicitudes.items | selectattr('decision', 'equalto', 'rechazado') | list | length }}</h3>
                <p class="mb-0">Rechazadas</p>
            </div>
            <div class="col-md-3">
                <h3>{{ solicitudes.items | selectattr('decision', 'equalto', None) | list | length }}</h3>
                <p class="mb-0">En Proceso</p>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-card">
        <form method="GET" class="row align-items-end">
            <div class="col-md-3 mb-2">
                <label class="form-label fw-bold">Filtrar por Estado:</label>
                <select name="estado" class="form-control form-control-custom">
                    <option value="">Todos los estados</option>
                    <option value="aprobado" {{ 'selected' if request.args.get('estado') == 'aprobado' }}>Aprobados</option>
                    <option value="rechazado" {{ 'selected' if request.args.get('estado') == 'rechazado' }}>Rechazados</option>
                    <option value="zona_gris" {{ 'selected' if request.args.get('estado') == 'zona_gris' }}>Zona Gris</option>
                    <option value="en_proceso" {{ 'selected' if request.args.get('estado') == 'en_proceso' }}>En Proceso</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label fw-bold">Fecha Desde:</label>
                <input type="date" name="fecha_desde" class="form-control form-control-custom" 
                       value="{{ request.args.get('fecha_desde', '') }}">
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label fw-bold">Fecha Hasta:</label>
                <input type="date" name="fecha_hasta" class="form-control form-control-custom" 
                       value="{{ request.args.get('fecha_hasta', '') }}">
            </div>
            <div class="col-md-3 mb-2">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-filter me-2"></i>Filtrar
                </button>
                <a href="{{ url_for('mis_solicitudes') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>Limpiar
                </a>
            </div>
        </form>
    </div>

    <!-- Tabla de Solicitudes -->
    <div class="card card-custom">
        <div class="card-header bg-transparent">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Lista de Solicitudes
                    </h5>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted">
                        Mostrando {{ solicitudes.items|length }} de {{ solicitudes.total }} solicitudes
                        {% if solicitudes.pages > 1 %}
                        - Página {{ solicitudes.page }} de {{ solicitudes.pages }}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if solicitudes.items %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Número</th>
                            <th>Cliente</th>
                            <th>RFC</th>
                            <th>Monto Solicitado</th>
                            <th>Monto Aprobado</th>
                            <th>Estado</th>
                            <th>FICO Score</th>
                            <th>TDSR</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for solicitud in solicitudes.items %}
                        <tr>
                            <td>
                                <span class="badge bg-secondary">{{ solicitud.numero }}</span>
                            </td>
                            <td>
                                {% if solicitud.cliente %}
                                    <strong>{{ solicitud.cliente.nombre }} {{ solicitud.cliente.apellido_paterno }}</strong><br>
                                    <small class="text-muted">{{ solicitud.cliente.edad }} años, {{ solicitud.cliente.ocupacion }}</small>
                                {% else %}
                                    <em class="text-muted">Sin cliente asignado</em>
                                {% endif %}
                            </td>
                            <td>
                                {% if solicitud.cliente %}
                                    <code>{{ solicitud.cliente.rfc }}</code>
                                {% else %}
                                    <em class="text-muted">N/A</em>
                                {% endif %}
                            </td>
                            <td>
                                {% if solicitud.monto_solicitado %}
                                    <strong>${{ "{:,.0f}".format(solicitud.monto_solicitado) }}</strong>
                                {% else %}
                                    <em class="text-muted">No definido</em>
                                {% endif %}
                            </td>
                            <td>
                                {% if solicitud.monto_aprobado %}
                                    <strong class="text-success">${{ "{:,.0f}".format(solicitud.monto_aprobado) }}</strong>
                                {% else %}
                                    <em class="text-muted">-</em>
                                {% endif %}
                            </td>
                            <td>
                                {% if solicitud.decision == 'aprobado' %}
                                    <span class="status-badge status-aprobado">
                                        <i class="fas fa-check me-1"></i>Aprobado
                                    </span>
                                {% elif solicitud.decision == 'rechazado' %}
                                    <span class="status-badge status-rechazado">
                                        <i class="fas fa-times me-1"></i>Rechazado
                                    </span>
                                {% elif solicitud.decision == 'zona_gris' %}
                                    <span class="status-badge status-zona_gris">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Zona Gris
                                    </span>
                                {% else %}
                                    <span class="status-badge status-en_proceso">
                                        <i class="fas fa-clock me-1"></i>En Proceso
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if solicitud.cliente %}
                                    {% if solicitud.cliente.fico_score >= 700 %}
                                        <span class="badge bg-success">{{ solicitud.cliente.fico_score }}</span>
                                    {% elif solicitud.cliente.fico_score >= 650 %}
                                        <span class="badge bg-warning">{{ solicitud.cliente.fico_score }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ solicitud.cliente.fico_score }}</span>
                                    {% endif %}
                                {% else %}
                                    <em class="text-muted">N/A</em>
                                {% endif %}
                            </td>
                            <td>
                                {% if solicitud.cliente %}
                                    {% if solicitud.cliente.tdsr <= 30 %}
                                        <span class="badge bg-success">{{ solicitud.cliente.tdsr }}%</span>
                                    {% elif solicitud.cliente.tdsr <= 35 %}
                                        <span class="badge bg-warning">{{ solicitud.cliente.tdsr }}%</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ solicitud.cliente.tdsr }}%</span>
                                    {% endif %}
                                {% else %}
                                    <em class="text-muted">N/A</em>
                                {% endif %}
                            </td>
                            <td>
                                <small>
                                    {{ solicitud.fecha_solicitud.strftime('%d/%m/%Y') }}<br>
                                    <span class="text-muted">{{ solicitud.fecha_solicitud.strftime('%H:%M') }}</span>
                                </small>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{{ url_for('ver_solicitud', id=solicitud.id) }}" 
                                       class="btn btn-sm btn-outline-info" 
                                       title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    {% if not solicitud.decision %}
                                        <a href="{{ url_for('evaluar_solicitud', id=solicitud.id) }}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Continuar evaluación">
                                            <i class="fas fa-play"></i>
                                        </a>
                                    {% elif solicitud.decision in ['aprobado', 'rechazado', 'zona_gris'] %}
                                        <a href="{{ url_for('resultado_solicitud', id=solicitud.id) }}" 
                                           class="btn btn-sm btn-outline-success" 
                                           title="Ver resultado">
                                            <i class="fas fa-file-alt"></i>
                                        </a>
                                    {% endif %}
                                    
                                    <button class="btn btn-sm btn-outline-secondary" 
                                            onclick="duplicarSolicitud({{ solicitud.id }})" 
                                            title="Duplicar solicitud">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación -->
            {% if solicitudes.pages > 1 %}
            <div class="card-footer bg-transparent">
                <nav aria-label="Paginación de solicitudes">
                    <ul class="pagination justify-content-center mb-0">
                        {% if solicitudes.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('mis_solicitudes', page=solicitudes.prev_num, **request.args) }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for page_num in solicitudes.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != solicitudes.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('mis_solicitudes', page=page_num, **request.args) }}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">…</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if solicitudes.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('mis_solicitudes', page=solicitudes.next_num, **request.args) }}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            
            {% else %}
            <!-- Estado vacío -->
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-4"></i>
                <h4 class="text-muted">No hay solicitudes</h4>
                <p class="text-muted mb-4">
                    {% if request.args.get('estado') or request.args.get('fecha_desde') or request.args.get('fecha_hasta') %}
                        No se encontraron solicitudes con los filtros aplicados.
                    {% else %}
                        Aún no has creado ninguna solicitud de crédito.
                    {% endif %}
                </p>
                <a href="{{ url_for('nueva_solicitud') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Crear Primera Solicitud
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Resumen de la Página -->
    {% if solicitudes.items %}
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card card-custom">
                <div class="card-body">
                    <h6><i class="fas fa-chart-pie me-2"></i>Resumen de esta Página</h6>
                    <div class="row text-center">
                        <div class="col-3">
                            <strong class="text-success">{{ solicitudes.items | selectattr('decision', 'equalto', 'aprobado') | list | length }}</strong><br>
                            <small>Aprobadas</small>
                        </div>
                        <div class="col-3">
                            <strong class="text-danger">{{ solicitudes.items | selectattr('decision', 'equalto', 'rechazado') | list | length }}</strong><br>
                            <small>Rechazadas</small>
                        </div>
                        <div class="col-3">
                            <strong class="text-warning">{{ solicitudes.items | selectattr('decision', 'equalto', 'zona_gris') | list | length }}</strong><br>
                            <small>Zona Gris</small>
                        </div>
                        <div class="col-3">
                            <strong class="text-info">{{ solicitudes.items | selectattr('decision', 'equalto', None) | list | length }}</strong><br>
                            <small>Pendientes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-
